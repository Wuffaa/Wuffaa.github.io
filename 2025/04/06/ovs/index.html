<!DOCTYPE html>
<html lang="zh-Hans">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="ovs" />
    <meta name="hexo-theme-A4" content="v1.9.7" />
    <link rel="alternate icon" type="image/webp" href="/images/Neurothingy.jpg">
    <title>Wuffaa | Blog</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


   
        
<link rel="stylesheet" href="/css/custom.css">

    

<meta name="generator" content="Hexo 6.3.0"></head>
    
    

    
    



    

    
    




    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 50%; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/images/Neurothingy.jpg" 
        />
        <div class="header-content">
            <a class="logo" href="/">Wuffaa</a> 
            <span class="description">el psy congroo</span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    ovs
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2025-04-11</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š6.7k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š27åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#POLL"><span class="post-toc-text">POLL</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#POLL-API"><span class="post-toc-text">POLL API</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#POLL%E5%8E%9F%E7%90%86"><span class="post-toc-text">POLLåŸç†</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#RCU-Read-Copy-Update"><span class="post-toc-text">RCU(Read-Copy-Update)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RCU-API"><span class="post-toc-text">RCU API</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RCU%E5%BA%94%E7%94%A8"><span class="post-toc-text">RCUåº”ç”¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#rcu-index"><span class="post-toc-text">rcu_index</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#rcu-list"><span class="post-toc-text">rcu_list</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#RCU%E5%8E%9F%E7%90%86"><span class="post-toc-text">RCUåŸç†</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#LATCH"><span class="post-toc-text">LATCH</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#LATCH-API"><span class="post-toc-text">LATCH API</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SEQ"><span class="post-toc-text">SEQ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SEQ-API"><span class="post-toc-text">SEQ API</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#COVERAGE"><span class="post-toc-text">COVERAGE</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%91%BD%E4%BB%A4"><span class="post-toc-text">å‘½ä»¤</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#API"><span class="post-toc-text">API</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8E%9F%E7%90%86"><span class="post-toc-text">åŸç†</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#PVECTOR-Concurrent-Priority-Vector"><span class="post-toc-text">PVECTOR(Concurrent Priority Vector)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#API-1"><span class="post-toc-text">API</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#CMAP-Concurrent-hash-map"><span class="post-toc-text">CMAP(Concurrent hash map)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#CCMAP"><span class="post-toc-text">CCMAP</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#CLS-CLASSIFIER"><span class="post-toc-text">CLS(CLASSIFIER)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#CLS-API"><span class="post-toc-text">CLS API</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#CLS%E5%BA%94%E7%94%A8"><span class="post-toc-text">CLSåº”ç”¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#router"><span class="post-toc-text">router</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#tnl%EF%BC%88tunnel%EF%BC%89"><span class="post-toc-text">tnlï¼ˆtunnelï¼‰</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#openflow-table"><span class="post-toc-text">openflow table</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#CLS%E5%8E%9F%E7%90%86"><span class="post-toc-text">CLSåŸç†</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%8E%A9%E7%A0%81%E4%BC%98%E5%8C%96"><span class="post-toc-text">æ©ç ä¼˜åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%88%86%E6%AE%B5hash%E5%8C%B9%E9%85%8D"><span class="post-toc-text">åˆ†æ®µhashåŒ¹é…</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%89%8D%E7%BC%80%E5%9F%9F%E5%8C%B9%E9%85%8D"><span class="post-toc-text">å‰ç¼€åŸŸåŒ¹é…</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%EF%BC%88Binary-trie%EF%BC%89"><span class="post-toc-text">å‰ç½®çŸ¥è¯†ï¼ˆBinary trieï¼‰</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%89%8D%E7%BC%80%E5%9F%9F"><span class="post-toc-text">è‡ªå®šä¹‰å‰ç¼€åŸŸ</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%86%85%E7%BD%AEl4-port%E5%89%8D%E7%BC%80%E5%9F%9F"><span class="post-toc-text">å†…ç½®l4 portå‰ç¼€åŸŸ</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%A7%84%E5%88%99%E7%89%88%E6%9C%AC%E5%8F%B7%E6%8E%A7%E5%88%B6"><span class="post-toc-text">è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#conjunction%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">conjunctionå®ç°</span></a></li></ol></li></ol></li></ol>
            
        
        <div class=".article-gallery"><h1 id="POLL"><a href="#POLL" class="headerlink" title="POLL"></a>POLL</h1><p>å¯¹ç³»ç»Ÿè°ƒç”¨pollçš„å°è£…ã€‚ovsçš„IOç­‰å¾…æœºåˆ¶ï¼Œé¿å…å¿™ç­‰å¾…ã€‚</p>
<h2 id="POLL-API"><a href="#POLL-API" class="headerlink" title="POLL API"></a>POLL API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨å†Œè¶…æ—¶æ—¶é—´ä¸ºmsecï¼ˆç›¸å¯¹æ—¶é—´ï¼‰çš„å®šæ—¶å™¨ï¼Œå¦‚æœmsecä¸ºè´Ÿæ•°ï¼Œåˆ™è¶…æ—¶æ—¶é—´ä¸º0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">poll_timer_wait</span><span class="params">(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> msec)</span>;</span><br><span class="line"><span class="comment">//æ³¨å†Œè¶…æ—¶æ—¶é—´ä¸ºwhenï¼ˆç»å¯¹æ—¶é—´ï¼‰çš„å®šæ—¶å™¨</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">poll_timer_wait_until</span><span class="params">(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span> when)</span>;</span><br><span class="line"><span class="comment">//æ³¨å†Œè¶…æ—¶æ—¶é—´ä¸º0ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰çš„å®šæ—¶å™¨</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">poll_immediate_wake</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°æ³¨å†Œçš„äº‹ä»¶(fd or timer)è¢«è§¦å‘</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">poll_block</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>



<h2 id="POLLåŸç†"><a href="#POLLåŸç†" class="headerlink" title="POLLåŸç†"></a>POLLåŸç†</h2><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„<code>poll_loop</code>ï¼Œé‡Œé¢å­˜å‚¨ç€æ‰€æœ‰å¾…ç›‘å¬çš„fdï¼ˆè¿™äº›äº‹ä»¶æ˜¯ç”±<code>poll_fd_wait()</code>æ‰€æ³¨å†Œçš„ï¼‰å’Œä¸€ä¸ªå®šæ—¶å™¨ï¼ˆé»˜è®¤ï¼‰ã€‚</p>
<p>æ¯æ¬¡æ‰§è¡Œ<code>poll_block()</code>æ—¶ï¼Œè°ƒç”¨<code>poll()</code>ç›‘å¬æ‰€æœ‰å¾…ç›‘å¬çš„fdï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚<code>poll()</code>è¿”å›åï¼Œæ¸…ç©ºé‡ç½®æ‰€æœ‰çš„fdå’Œå®šæ—¶å™¨ã€‚å› æ­¤ä¸‹æ¬¡æ‰§è¡Œ<code>poll_block()</code>ä¹‹å‰ï¼Œéœ€è¦é‡æ–°å°†éœ€è¦ç›‘å¬çš„äº‹ä»¶æ·»åŠ åˆ°<code>poll_loop</code>ä¸­ã€‚</p>
<h1 id="RCU-Read-Copy-Update"><a href="#RCU-Read-Copy-Update" class="headerlink" title="RCU(Read-Copy-Update)"></a>RCU(Read-Copy-Update)</h1><p>ovsç”¨äºå®ç°æ— é”åŒ–çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤æŒ‡é’ˆå˜é‡ã€‚è¯»å†™é”æ¨¡å‹ï¼Œå¤šä¸ªè¯»è€…å¯æ— é”æ“ä½œï¼Œå¤šä¸ªå†™è€…éœ€ä¸Šé”æ“ä½œï¼ˆå•ä¸ªå†™è€…æ— éœ€ä¸Šé”ï¼‰ã€‚</p>
<h2 id="RCU-API"><a href="#RCU-API" class="headerlink" title="RCU API"></a>RCU API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rcuå˜é‡ç±»å‹</span></span><br><span class="line">OVSRCU_TYPE(TYPE)</span><br><span class="line"><span class="comment">//rcuå˜é‡åˆå§‹åŒ–ï¼Œå®šä¹‰æ—¶ä½¿ç”¨</span></span><br><span class="line">OVSRCU_INITIALIZER(VALUE)</span><br><span class="line"><span class="comment">//rcuå˜é‡åˆå§‹åŒ–ï¼Œå®šä¹‰åä½¿ç”¨</span></span><br><span class="line">ovsrcu_init(VAR, VALUE)</span><br></pre></td></tr></table></figure>



<p><strong>å†™è€…ä½¿ç”¨</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®rcuå˜é‡ï¼Œè¯¥å˜é‡æ‰€å±çš„æ•°æ®ç»“æ„ç›®å‰è¿˜ä¸èƒ½è¢«å…¶ä»–readerçœ‹åˆ°ã€‚æ¯”å¦‚å†™è€…ç”³è¯·ä¸€ä¸ªæ•°æ®ç»“æ„å¹¶åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ—¶è¯¥æ•°æ®ç»“æ„å¹¶ä¸ä¼šè¢«å…¶ä»–è¯»è€…æ‰€çœ‹è§ï¼Œå› ä¸ºè¿˜æ²¡æœ‰æ›´æ–°åˆ°å…¨å±€æ•°æ®ç»“æ„ä¸­ã€‚æ­¤æ—¶å¯¹è¯¥æ•°æ®ç»“æ„ä¸­çš„rcuæˆå‘˜è®¾ç½®å°±å¯ä»¥ä½¿ç”¨è¯¥api</span></span><br><span class="line">ovsrcu_set_hidden(VAR, VALUE)</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®rcuå˜é‡ï¼Œè®¾ç½®åè¯¥å˜é‡å°±å¯èƒ½è¢«å…¶ä»–readerçœ‹åˆ°ã€‚</span></span><br><span class="line">ovsrcu_set(VAR, VALUE)</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–rcuå˜é‡ï¼Œè¯¥å˜é‡è¢«ä¿æŠ¤ï¼ˆä¾‹å¦‚äº’æ–¥é”ï¼‰</span></span><br><span class="line">ovsrcu_get_protected(TYPE, VAR)</span><br><span class="line"></span><br><span class="line"><span class="comment">//rcuèµ„æºæ¸…ç†å‡½æ•°æ³¨å†Œï¼Œå½“æ‰€æœ‰è¯»è€…ä¸å†å¼•ç”¨è¯¥å˜é‡ä¹‹åä¼šè°ƒç”¨</span></span><br><span class="line">ovsrcu_postpone(FUNCTION, ARG)</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼šå†™è€…æ›´æ–°rcuå˜é‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ovs_mutex</span> <span class="title">mutex</span> =</span> OVS_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line">OVSRCU_TYPE(<span class="keyword">struct</span> flow *) flowp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">change_flow</span><span class="params">(<span class="keyword">struct</span> flow *new_flow)</span></span><br><span class="line">&#123;</span><br><span class="line">             <span class="comment">//å¤šå†™è€…æ—¶ä½¿ç”¨äº’æ–¥æœºåˆ¶ï¼Œé˜²æ­¢å¤šä¸ªå†™è€…è·å–åˆ°ç›¸åŒçš„rcuå˜é‡</span></span><br><span class="line">    ovs_mutex_lock(&amp;mutex);</span><br><span class="line">    ovsrcu_postpone(<span class="built_in">free</span>,</span><br><span class="line">                    ovsrcu_get_protected(<span class="keyword">struct</span> flow *, &amp;flowp));</span><br><span class="line">    ovsrcu_set(&amp;flowp, new_flow);</span><br><span class="line">    ovs_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>è¯»è€…ä½¿ç”¨</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯»å–rcuå˜é‡ï¼Œè¯»è€…ä½¿ç”¨</span></span><br><span class="line">ovsrcu_get(TYPE, VAR)</span><br></pre></td></tr></table></figure>



<p><strong>rcuç®¡ç†å‡½æ•°</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è§¦å‘é™é»˜æœŸï¼Œæ›´æ–°å½“å‰çº¿ç¨‹çš„ç‰ˆæœ¬å·ä¸ºglobal_seqnoï¼Œå¹¶ä½¿global_seqnoåŠ 1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_quiesce</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"><span class="comment">//å°è¯•è§¦å‘é™é»˜æœŸï¼Œè‹¥å°è¯•å¤±è´¥ï¼Œåˆ™è¿”å›EBUSY</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_try_quiesce</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è§¦å‘é™é»˜æœŸï¼Œä¸ä¸Šé¢çš„åŒºåˆ«æ˜¯ï¼Œåœ¨è°ƒç”¨start-endæœŸé—´ä¼šå°†è¯¥çº¿ç¨‹ä¸‹çº¿ï¼Œä½¿å¾—ç®¡ç†çº¿ç¨‹è®¡ç®—å®½é™æœŸæ—¶ä¸è€ƒè™‘è¯¥çº¿ç¨‹</span></span><br><span class="line"><span class="comment">//è¯¥çº¿ç¨‹ä¸‹çº¿æ—¶ä¼šä½¿global_seqnoåŠ 1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_quiesce_start</span><span class="params">(<span class="type">void</span>)</span>	<span class="comment">//ä¸‹çº¿</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_quiesce_end</span><span class="params">(<span class="type">void</span>)</span>	<span class="comment">//ä¸Šçº¿</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è·å–è¯¥çº¿ç¨‹æ˜¯å¦å¤„äºé™é»˜çŠ¶æ€ï¼ˆæ˜¯å¦ä¸‹çº¿ï¼‰</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_is_quiescent</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç­‰å¾…å®½é™æœŸç»“æŸï¼ˆä¹Ÿå°±æ˜¯ç­‰å¾…æ‰€æœ‰ä¸Šçº¿çš„çº¿ç¨‹è‡³å°‘è§¦å‘è¿‡ä¸€æ¬¡é™é»˜æœŸï¼‰ï¼Œè¿™é‡Œå¯ä»¥é˜»å¡å¾ˆä¹…</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_synchronize</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//rcuèµ„æºå›æ”¶çº¿ç¨‹ï¼Œå½“ovså¤„äºå¤šçº¿ç¨‹æ¨¡å¼ä¸‹è‡ªåŠ¨åˆ›å»º</span></span><br><span class="line"><span class="comment">//ovsrcu_quiesce_startå’Œovsrcu_quiesceä¼šè§¦å‘ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°éƒ½å°†ä¼šå°†è¦å›æ”¶çš„èµ„æºåŒæ­¥åˆ°å…¨å±€æ•°æ®ç»“æ„ä¸­ï¼Œæ­¤æ—¶å°±éœ€è¦æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥åšè¿™äº›èµ„æºçš„å›æ”¶</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">ovsrcu_postpone_thread</span><span class="params">(<span class="type">void</span> *arg OVS_UNUSED)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//rcuå±éšœï¼Œè¯¥å‡½æ•°è‡³å°‘ä¼šç»å†ä¸€ä¸ªå®½é™æœŸï¼ŒåŒæ—¶ä¿è¯æ‰€æœ‰çš„æ—§èµ„æºéƒ½å·²ç»å›æ”¶å®Œæ¯•ã€‚</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ovsrcu_barrier</span><span class="params">(<span class="type">void</span>)</span></span><br></pre></td></tr></table></figure>

<p>rcuå±éšœçš„ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">rcu_cb</span><span class="params">(<span class="type">void</span> *A)</span> &#123;</span><br><span class="line">    do_something(A);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">destroy_A</span><span class="params">()</span> &#123;</span><br><span class="line">    ovsrcu_postpone(rcu_cb, A); <span class="comment">// will use A later</span></span><br><span class="line">    ovsrcu_barrier(); <span class="comment">// wait for rcu_cb done</span></span><br><span class="line">    do_destroy_A(); <span class="comment">// free A</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="RCUåº”ç”¨"><a href="#RCUåº”ç”¨" class="headerlink" title="RCUåº”ç”¨"></a>RCUåº”ç”¨</h2><h3 id="rcu-index"><a href="#rcu-index" class="headerlink" title="rcu_index"></a>rcu_index</h3><p>ä½¿ç”¨æ•´æ•°è€Œä¸æ˜¯æŒ‡é’ˆä½œä¸ºrcuå˜é‡ã€‚åœ¨ä¸€äº›éœ€è¦ä¿æŠ¤çš„æ•°æ®ä¸æ˜¯æŒ‡é’ˆå½¢å¼çš„å†…å®¹ï¼Œè€Œæ˜¯æ•°ç»„æˆå‘˜æ—¶å¾ˆæœ‰ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ovs_mutex</span> <span class="title">mutex</span> =</span> OVS_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line">ovsrcu_index port_id;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">tx</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> id = ovsrcu_index_get(&amp;port_id);</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    port_tx(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    ovs_mutex_lock(&amp;mutex);</span><br><span class="line">    id = ovsrcu_index_get_protected(&amp;port_id);</span><br><span class="line">    ovsrcu_index_set(&amp;port_id, <span class="number">-1</span>);</span><br><span class="line">    ovs_mutex_unlock(&amp;mutex);</span><br><span class="line"></span><br><span class="line">    ovsrcu_synchronize();</span><br><span class="line">    port_delete(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="rcu-list"><a href="#rcu-list" class="headerlink" title="rcu_list"></a>rcu_list</h3><p>ä¸ovs_listä½¿ç”¨æ–¹æ³•ä¸€æ ·</p>
<h2 id="RCUåŸç†"><a href="#RCUåŸç†" class="headerlink" title="RCUåŸç†"></a>RCUåŸç†</h2><ul>
<li>rcuä¸šåŠ¡çº¿ç¨‹ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª<code>ovsrcu_perthread</code>ï¼Œç”¨äºè®°å½•è¯¥çº¿ç¨‹çš„ç‰ˆæœ¬å·å’Œå¾…é‡Šæ”¾çš„èµ„æºï¼Œæ¯å½“çº¿ç¨‹è§¦å‘é™é»˜æœŸï¼Œéƒ½ä¼šå°†è¯¥çº¿ç¨‹çš„æ‰€æœ‰å¾…é‡Šæ”¾çš„èµ„æºæ”¾åˆ°å…¨å±€<code>flushed_cbsets</code>ä¸­ï¼Œå¹¶æ›´æ–°å…¨å±€ç‰ˆæœ¬å·ã€‚</li>
<li>rcuç®¡ç†çº¿ç¨‹ï¼šç›‘æ§<code>flushed_cbsets</code>çš„å˜åŒ–ï¼ˆå¦‚æœæœ‰ä¸€ä¸ªércuç®¡ç†çº¿ç¨‹è§¦å‘äº†é™é»˜æœŸï¼Œåˆ™<code>flushed_cbsets</code>å‘ç”Ÿå˜åŒ–ï¼‰ï¼Œå¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™è·å–<code>flushed_cbsets</code>ä¸Šçš„èµ„æºï¼Œå¹¶ç­‰å¾…å½“å‰ç‰ˆæœ¬çš„å®½é™æœŸï¼Œå®½é™æœŸè¿‡åè¿›è¡Œèµ„æºçš„å›æ”¶ã€‚</li>
</ul>
<blockquote>
<p>å¦‚æœåªæœ‰ä¸€ä¸ªrcuä¸šåŠ¡çº¿ç¨‹ï¼Œåˆ™ä¸åˆ›å»ºrcuç®¡ç†çº¿ç¨‹ã€‚æ­¤æ—¶æ¯æ¬¡çº¿ç¨‹è§¦å‘é™é»˜æœŸæ—¶ï¼Œç›¸å½“äºç»å†è¿‡äº†å½“å‰çš„å®½é™æœŸï¼Œè¯¥çº¿ç¨‹ç›´æ¥è¿›è¡Œèµ„æºçš„å›æ”¶</p>
</blockquote>
<p>åœ¨è¿›è¡Œpoll_blockæ—¶ï¼Œä¼šè§¦å‘è¯¥çº¿ç¨‹çš„é™é»˜æœŸï¼š</p>
<ul>
<li>å¦‚æœpolléœ€è¦ä¼‘çœ ï¼šåœ¨ä¼‘çœ å‰åæ‰§è¡Œ<code>ovsrcu_quiesce_start()</code>å’Œ<code>ovsrcu_quiesce_end()</code></li>
<li>å¦‚æœpollä¸éœ€è¦ä¼‘çœ ï¼šæ‰§è¡Œ<code>ovsrcu_quiesce()</code></li>
</ul>
<h1 id="LATCH"><a href="#LATCH" class="headerlink" title="LATCH"></a>LATCH</h1><p>ä¸€ç§å¼‚æ­¥çš„äº‹ä»¶è§¦å‘æœºåˆ¶ï¼Œç”¨äºé€šçŸ¥å…¶ä»–çº¿ç¨‹æŸä¸ªäº‹ä»¶å‘ç”Ÿ.</p>
<p>å°†latchä¸ç‰¹å®šäº‹ä»¶ç»‘å®šï¼Œlatché€šè¿‡åˆ›å»ºpipeç®¡é“ï¼Œå°†ç®¡é“çš„è¯»ä¾§æ”¾åˆ°pollä¸­è¿›è¡Œç›‘å¬ã€‚å½“è¯¥äº‹ä»¶è§¦å‘æ—¶ï¼Œå‘ç®¡é“çš„å†™ä¾§å†™å…¥æ•°æ®ï¼Œå”¤é†’pollï¼Œç›‘å¬è€…å°±å¯é€šè¿‡åˆ¤æ–­è¯»ä¾§æ˜¯å¦æœ‰æ•°æ®å¯è¯»æ¥æˆ–è€…è¯¥äº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚</p>
<h2 id="LATCH-API"><a href="#LATCH-API" class="headerlink" title="LATCH API"></a>LATCH API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºpipeç®¡é“</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">latch_init</span><span class="params">(<span class="keyword">struct</span> latch *)</span>;</span><br><span class="line"><span class="comment">//é€šè¿‡å‘pipeè¯»ä¾§è¯»å–æ•°æ®æ¥è¾¾åˆ°é‡ç½®latchçš„ç›®çš„</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">latch_poll</span><span class="params">(<span class="keyword">struct</span> latch *)</span>;</span><br><span class="line"><span class="comment">//é€šè¿‡å‘pipeå†™ä¾§å†™å…¥1å­—èŠ‚æ•°æ®æ¥å”¤é†’latch</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">latch_set</span><span class="params">(<span class="keyword">struct</span> latch *)</span>;</span><br><span class="line"><span class="comment">//é€šè¿‡åˆ¤æ–­pipeè¯»ä¾§æ˜¯å¦æœ‰æ•°æ®å¯è¯»æ¥åˆ¤æ–­latchæ˜¯å¦è¢«å”¤é†’</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">latch_is_set</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> latch *)</span>;</span><br><span class="line"><span class="comment">//å°†latchæ”¾åˆ°pollä¸­è¿›è¡Œç›‘å¬</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">latch_wait</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> latch *)</span>;</span><br></pre></td></tr></table></figure>



<p>åœ¨ovsä¸­latchä¸€èˆ¬ç”¨äºç›‘æ§çº¿ç¨‹é€€å‡ºæˆ–è€…åŠŸèƒ½æ¨¡å—é€€å‡ºè¿™ç±»çš„äº‹ä»¶ã€‚</p>
<h1 id="SEQ"><a href="#SEQ" class="headerlink" title="SEQ"></a>SEQ</h1><p>ç”¨äºç›‘æ§æŸç±»æ„Ÿå…´è¶£çš„äº‹ä»¶æˆ–çŠ¶æ€çš„åºåˆ—å·ã€‚å½“äº‹ä»¶è§¦å‘æˆ–çŠ¶æ€æ”¹å˜æ—¶ï¼Œåºåˆ—å·å˜åŒ–ã€‚</p>
<h2 id="SEQ-API"><a href="#SEQ-API" class="headerlink" title="SEQ API"></a>SEQ API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> seq *<span class="title function_">seq_create</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">//æ›´æ–°åºåˆ—å·ï¼Œè¯¥è¡Œä¸ºä¼šå”¤é†’ç­‰å¾…åºåˆ—å·æ›´æ–°çš„ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">seq_change</span><span class="params">(<span class="keyword">struct</span> seq *seq)</span>;</span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">seq_read</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> seq *seq)</span>;</span><br><span class="line"><span class="comment">//å°†åºåˆ—å·æ”¾åˆ°pollä¸­è¿›è¡Œç›‘å¬ï¼Œå½“åºåˆ—å·ä¸ç­‰äºvalueæ—¶è¢«å”¤é†’</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">seq_wait</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> seq *seq, <span class="type">uint64_t</span> value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//example</span></span><br><span class="line">new_seq = seq_read(seq);</span><br><span class="line"><span class="keyword">if</span> (new_seq != last_seq) &#123;</span><br><span class="line">    ...process changes...</span><br><span class="line">    last_seq = new_seq;</span><br><span class="line">&#125;</span><br><span class="line">seq_wait(seq, new_seq);</span><br><span class="line">pool_block();</span><br></pre></td></tr></table></figure>



<p><code>seq_wait()</code>åŸç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* A sequence number object. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_uint64_t</span> value;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">waiters</span> <span class="title">OVS_GUARDED</span>;</span> <span class="comment">/* Contains &#x27;struct seq_waiter&#x27;s. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* A thread waiting on a particular seq. */</span></span><br><span class="line"><span class="comment">//åœ¨seqä¸­æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ª</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_waiter</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">hmap_node</span> <span class="title">OVS_GUARDED</span>;</span> <span class="comment">/* In &#x27;seq-&gt;waiters&#x27;. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seq</span> *<span class="title">seq</span> <span class="title">OVS_GUARDED</span>;</span>            <span class="comment">/* Seq being waited for. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ovsthread_id OVS_GUARDED;  <span class="comment">/* Key in &#x27;waiters&#x27; hmap. */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seq_thread</span> *<span class="title">thread</span> <span class="title">OVS_GUARDED</span>;</span>  <span class="comment">/* Thread preparing to wait. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> <span class="title">list_node</span> <span class="title">OVS_GUARDED</span>;</span>  <span class="comment">/* In &#x27;thread-&gt;waiters&#x27;. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> value OVS_GUARDED; <span class="comment">/* seq-&gt;value we&#x27;re waiting to change. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* A thread that might be waiting on one or more seqs. */</span></span><br><span class="line"><span class="comment">//æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªï¼Œå¯è¢«å¤šä¸ªseqè°ƒç”¨</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_thread</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> <span class="title">waiters</span> <span class="title">OVS_GUARDED</span>;</span> <span class="comment">/* Contains &#x27;struct seq_waiter&#x27;s. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">latch</span> <span class="title">latch</span> <span class="title">OVS_GUARDED</span>;</span>  <span class="comment">/* Wakeup latch for this thread. */</span></span><br><span class="line">    <span class="comment">//å½“waitersä¸ºç©ºæ—¶ï¼Œwaitingä¸ºfalse</span></span><br><span class="line">    <span class="type">bool</span>  waiting OVS_GUARDED;        <span class="comment">/* True if latch_wait() already called. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>seq_wait()</p>
<ul>
<li>åˆ¤æ–­è¯¥<code>seq</code>ä¸­æ˜¯å¦å­˜åœ¨è¯¥çº¿ç¨‹çš„<code>seq_waiter</code><ul>
<li>å­˜åœ¨ï¼šåˆ¤æ–­æ­¤æ¬¡çš„<code>value</code>æ˜¯å¦ç­‰äº<code>seq_waiter</code>çš„<code>value</code><ul>
<li>ç›¸ç­‰ï¼šè¯´æ˜è¯¥çº¿ç¨‹ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡<code>seq_wait()</code>ï¼Œç›´æ¥é€€å‡ºå³å¯</li>
<li>ä¸ç›¸ç­‰ï¼šè¯´æ˜å½“å‰éœ€è¦ç›‘å¬çš„<code>value</code>å·²ç»ä¸ä¹‹å‰ç›‘å¬çš„<code>value</code>ä¸ç›¸ç­‰ï¼Œè®¾ç½®pollçš„è¶…æ—¶æ—¶é—´ä¸º0ï¼Œç«‹å³å”¤é†’poll</li>
</ul>
</li>
<li>ä¸å­˜åœ¨ï¼šåˆ›å»ºè¯¥çº¿ç¨‹çš„<code>seq_waiter</code>ï¼Œå°†è¯¥çº¿ç¨‹çš„<code>latch</code>æ”¾åˆ°pollä¸­è¿›è¡Œç›‘å¬</li>
</ul>
</li>
</ul>
<p>seq_change()</p>
<ul>
<li>æ›´æ–°<code>seq</code></li>
<li>å”¤é†’è¯¥<code>seq</code>ä¸­æ‰€æœ‰çš„<code>waiter</code>(é€šè¿‡å‘<code>waiter</code>æ‰€å±çº¿ç¨‹çš„<code>latch</code>æ‰§è¡Œ<code>latch_set()</code>è¾¾åˆ°)</li>
<li>åˆ é™¤è¯¥<code>seq</code>ä¸­æ‰€æœ‰çš„<code>waiter</code></li>
</ul>
<p>poll_block()</p>
<ul>
<li>è¢«å”¤é†’åï¼Œåˆ é™¤è¯¥çº¿ç¨‹çš„æ‰€æœ‰çš„<code>waiter</code></li>
<li>å°†è¯¥çº¿ç¨‹çš„<code>latch</code>å¤ä½ï¼Œæ¸…é™¤<code>waiting</code>æ ‡è®°</li>
</ul>
<h1 id="COVERAGE"><a href="#COVERAGE" class="headerlink" title="COVERAGE"></a>COVERAGE</h1><p>ovsç”¨æ¥è¿½è¸ªäº‹ä»¶çš„æ›´æ–°é¢‘ç‡</p>
<h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-appctl coverage/show</span><br><span class="line">ovs-appctl coverage/read-counter XXX</span><br></pre></td></tr></table></figure>



<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">COVERAGE_DEFINE(COUNTER);</span><br><span class="line">COVERAGE_INC(COUNTER);</span><br><span class="line">COVERAGE_ADD(COUNTER);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†è¯¥çº¿ç¨‹çš„coverageåŒæ­¥åˆ°å…¨å±€å˜é‡ä¸­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">coverage_clear</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">//ä¸Šé”å¤±è´¥åˆ™ä¸åŒæ­¥ï¼Œç”¨åœ¨pmdçº¿ç¨‹ä¸­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">coverage_try_clear</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ›´æ–°counteræ•°æ®</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">coverage_run</span><span class="params">(<span class="type">void</span>)</span></span><br></pre></td></tr></table></figure>



<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>æ¯ä¸ªcounteréƒ½ä¼šå¯¹åº”ä¸€ä¸ªå…¨å±€å˜é‡å’ŒNä¸ªæ¯çº¿ç¨‹å˜é‡</p>
<ul>
<li><p>å…¨å±€å˜é‡ï¼š<code>struct coverage_counter</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* A coverage counter. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">coverage_counter</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> name;            <span class="comment">/* Textual name. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*<span class="type">const</span> count)</span><span class="params">(<span class="type">void</span>)</span>; <span class="comment">/* Gets, zeros this thread&#x27;s count. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> total;      <span class="comment">/* Total count. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> last_total;</span><br><span class="line">    <span class="comment">/* The moving average arrays. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> min[MIN_AVG_LEN];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> hr[HR_AVG_LEN];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¯çº¿ç¨‹å˜é‡ï¼š<code>unsigned int</code></p>
</li>
</ul>
<p>æ¯ä¸ªçº¿ç¨‹é€šè¿‡å‘¨æœŸæ€§è°ƒç”¨<code>coverage_clear()/coverage_try_clear()</code>å°†çº¿ç¨‹çš„ç§æœ‰è®¡æ•°åŒæ­¥åˆ°è¯¥counterçš„å…¨å±€å˜é‡ä¸­ï¼Œæ¯<code>COVERAGE_CLEAR_INTERVAL</code>ï¼ˆ1ç§’ï¼‰æ‰§è¡Œä¸€æ¬¡ã€‚</p>
<p><code>coverage_run()</code>æ‰§è¡ŒçœŸæ­£çš„è®¡æ•°ç»Ÿè®¡ï¼Œæ¯<code>COVERAGE_RUN_INTERVAL</code>ï¼ˆ5ç§’ï¼‰æ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥å€¼å¯ä»¥ä¿®æ”¹ï¼Œä½†å¿…é¡»èƒ½å¤Ÿè¢«6000ï¼ˆ60ç§’ï¼‰æ•´é™¤ï¼Œå› ä¸ºcounterçš„å…¨å±€å˜é‡ä¸­<code>min</code>æ•°ç»„å­˜å‚¨ç€æœ€åä¸€åˆ†é’Ÿçš„è®¡æ•°ï¼Œè¯¥æ•°ç»„å°†ä¸€åˆ†é’Ÿåˆ†æˆ<code>6000/COVERAGE_RUN_INTERVAL</code>ä»½ï¼Œæ¯ä»½å­˜å‚¨<code>COVERAGE_RUN_INTERVAL</code>é—´éš”çš„counterè®¡æ•°ã€‚åŒç†<code>hr</code>æ•°ç»„å­˜å‚¨ç€æœ€åä¸€å°æ—¶çš„è®¡æ•°ï¼Œè¯¥æ•°ç»„è¢«åˆ†ä¸º<code>HR_AVG_LEN</code>ï¼ˆ60ï¼‰ä»½ï¼Œæ¯ä»½å­˜å‚¨é—´éš”ä¸€åˆ†é’Ÿçš„counterè®¡æ•°ã€‚</p>
<p><code>idx_count</code>ç¡®å®šäº†<code>min</code>å’Œ<code>hr</code>æ•°ç»„å½“å‰çš„ç´¢å¼•ï¼Œæ›´æ–°çš„ç»Ÿè®¡ä¼šå­˜æ”¾åœ¨<code>idx_count</code>åŠå…¶åé¢çš„ç´¢å¼•ä¸­ï¼Œç±»ä¼¼ä¸€ä¸ªç¯ã€‚</p>
<p>ä¾‹å¦‚å½“<code>COVERAGE_RUN_INTERVAL</code>ä¸º12sæ—¶ï¼Œminä¸­æ•°æ®çš„åˆ†å¸ƒå¦‚ä¸‹ï¼š</p>
<p><a href="/images/coverage_min.svg" title="coverage_min" class="gallery-item" style="box-shadow: none;"> <img src="/images/coverage_min.svg" alt="coverage_min"></a></p>
<p>poll_block()</p>
<ul>
<li>åœ¨æ‰§è¡Œ<code>poll()</code>ä¹‹å‰è°ƒç”¨<code>coverage_clear()</code>å’Œ<code>coverage_run()</code></li>
</ul>
<h1 id="PVECTOR-Concurrent-Priority-Vector"><a href="#PVECTOR-Concurrent-Priority-Vector" class="headerlink" title="PVECTOR(Concurrent Priority Vector)"></a>PVECTOR(Concurrent Priority Vector)</h1><p>å•å†™è€…ï¼Œå¤šè¯»è€…çš„ä¼˜å…ˆçº§æ•°ç»„ï¼Œä¼˜å…ˆçº§é«˜çš„æ’åœ¨æ•°ç»„çš„å‰é¢ã€‚</p>
<p>pvectorå†…éƒ¨ä½¿ç”¨ä¸¤ä¸ªä¼˜å…ˆçº§æ•°ç»„ï¼š</p>
<ul>
<li>implï¼šå·²å‘å¸ƒçš„æ•°ç»„ï¼Œè¯¥æ•°ç»„è¢«è¯»è€…å¯è§</li>
<li>tempï¼šä¸´æ—¶æ•°ç»„ï¼Œä¿å­˜ç€æœ€æ–°çš„æ•°æ®ï¼Œè¯¥æ•°ç»„ä»…è¢«å†™è€…å¯è§ã€‚åªæœ‰å½“æ‰§è¡Œ<code>pvector_publish()</code>åï¼Œè¯¥æ•°ç»„æ‰ä¼šæ›´æ–°åˆ°<code>impl</code>ä¸­ã€‚</li>
</ul>
<h2 id="API-1"><a href="#API-1" class="headerlink" title="API"></a>API</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">pvector_init</span><span class="params">(<span class="keyword">struct</span> pvector *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯èƒ½å°†å…¶æ›´æ–°åˆ°tempæ•°ç»„ä¸­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pvector_insert</span><span class="params">(<span class="keyword">struct</span> pvector *, <span class="type">void</span> *, <span class="type">int</span> priority)</span>;</span><br><span class="line"><span class="comment">//å¯èƒ½å°†å…¶æ›´æ–°åˆ°tempæ•°ç»„ä¸­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pvector_change_priority</span><span class="params">(<span class="keyword">struct</span> pvector *, <span class="type">void</span> *, <span class="type">int</span> priority)</span>;</span><br><span class="line"><span class="comment">//å°†å…¶æ›´æ–°åˆ°tempæ•°ç»„ä¸­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pvector_remove</span><span class="params">(<span class="keyword">struct</span> pvector *, <span class="type">void</span> *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æœ€æ–°ä¿®æ”¹çš„tempæ•°ç»„å‘å¸ƒåˆ°implä¸­ï¼Œæ­¤åçš„è¯»è€…å¯ä»¥éå†åˆ°æœ€æ–°çš„pvector</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">pvector_publish</span><span class="params">(<span class="keyword">struct</span> pvector *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢apiä¸ºè¯»è€…æ‰€ç”¨</span></span><br><span class="line"><span class="comment">/* Make the modified pvector available for iteration. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">pvector_publish</span><span class="params">(<span class="keyword">struct</span> pvector *)</span>;</span><br><span class="line"><span class="comment">/* Count.  These operate on the published pvector. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title function_">pvector_count</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> pvector *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">pvector_is_empty</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> pvector *)</span>;</span><br><span class="line"><span class="comment">//æŒ‰ä»é«˜åˆ°ä½çš„ä¼˜å…ˆçº§éå†</span></span><br><span class="line">PVECTOR_FOR_EACH(PTR, PVECTOR)</span><br><span class="line"><span class="comment">//æŒ‰ä»é«˜åˆ°ä½çš„ä¼˜å…ˆçº§éå†ï¼Œå…¶ä¸­éå†åˆ°çš„ä¼˜å…ˆçº§éœ€è¦å¤§äºç­‰äºPRIORITYã€‚åœ¨éå†è¿‡ç¨‹ä¸­é¢„å–Nä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ çš„å¤§å°ä¸ºSZ</span></span><br><span class="line">PVECTOR_FOR_EACH_PRIORITY(PTR, PRIORITY, N, SZ, PVECTOR)</span><br></pre></td></tr></table></figure>



<h1 id="CMAP-Concurrent-hash-map"><a href="#CMAP-Concurrent-hash-map" class="headerlink" title="CMAP(Concurrent hash map)"></a>CMAP(Concurrent hash map)</h1><p> å•å†™è€…ï¼Œå¤šè¯»è€…çš„hashè¡¨ã€‚</p>
<p>TODO</p>
<h1 id="CCMAP"><a href="#CCMAP" class="headerlink" title="CCMAP"></a>CCMAP</h1><p>å•å†™è€…ï¼Œå¤šè¯»è€…çš„hashè¡¨ï¼Œå…¶ä¸­valueåªè®°å½•æ’å…¥åˆ°hashä¸­çš„è¯¥hashå€¼çš„ä¸ªæ•°ã€‚</p>
<p>TODO</p>
<h1 id="CLS-CLASSIFIER"><a href="#CLS-CLASSIFIER" class="headerlink" title="CLS(CLASSIFIER)"></a>CLS(CLASSIFIER)</h1><p>slowpathçš„æŠ¥æ–‡åˆ†ç±»å™¨ï¼Œæ ¹æ®ä¸‹å‘çš„è§„åˆ™ï¼Œå¯¹è¾“å…¥flowè¿›è¡ŒåŒ¹é…ï¼Œè¿”å›å‘½ä¸­çš„è§„åˆ™å¹¶è®¾ç½®è¯¥æ¬¡åŒ¹é…æ‰€æ„Ÿå…´è¶£çš„æ©ç ï¼ˆå¦‚æœæœ‰éœ€è¦çš„è¯ï¼‰ã€‚è¿™ä¸ªæ©ç ä¸ºfastpathæ‰€ç”¨ï¼Œfastpathä¼šæ ¹æ®æ©ç ä¸‹å‘å¹¶ç”Ÿæˆfastpathè§„åˆ™ï¼Œä½¿åé¢ç±»ä¼¼çš„æµé‡ï¼ˆæ©ç åå‘½ä¸­fastpathè§„åˆ™ï¼‰è¿›è¡Œå¿«è½¬ã€‚</p>
<h2 id="CLS-API"><a href="#CLS-API" class="headerlink" title="CLS API"></a>CLS API</h2><p>clsåˆå§‹åŒ–å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">classifier_init</span><span class="params">(<span class="keyword">struct</span> classifier *, <span class="type">const</span> <span class="type">uint8_t</span> *flow_segments)</span>;</span><br></pre></td></tr></table></figure>

<p>flow_segmentsä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºåˆ†æ®µç‚¹åœ¨flowä¸­çš„åç§»ï¼ˆ8å­—èŠ‚ä¸ºä¸€ä¸ªå•ä½ï¼‰ï¼Œæ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ çš„å€¼ä¸€å®šæ˜¯æ•´ä¸ªflowçš„å¤§å°ï¼ˆ8å­—èŠ‚ä¸ºä¸€ä¸ªå•ä½ï¼‰ã€‚</p>
<p>flow_segmentsä¼šå½±å“clsæ„å»ºçš„è¡Œä¸ºï¼Œåœ¨æ„å»ºæ—¶é€šè¿‡å¯¹flowè¿›è¡Œåˆ†æ®µï¼ŒåŠ é€Ÿäº†åŒ¹é…è¿‡ç¨‹ï¼Œä½¿å¾—å¯¹äºæ— æ³•å‘½ä¸­è§„åˆ™çš„flowèƒ½å¤Ÿæ›´å¿«é€Ÿçš„ç¡®å®šã€‚</p>
<p>clsè§„åˆ™åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cls_rule_init</span><span class="params">(<span class="keyword">struct</span> cls_rule *rule, <span class="type">const</span> <span class="keyword">struct</span> match *match, <span class="type">int</span> priority)</span>ï¼›</span><br></pre></td></tr></table></figure>



<p>clsè§„åˆ™æ’å…¥å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cls_conjunction</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> id;	<span class="comment">//conjunction_id</span></span><br><span class="line">    <span class="type">uint8_t</span> clause;	<span class="comment">//è¡¨æ˜è¯¥è§„åˆ™ä¸ºconjunction_idçš„ç¬¬å‡ ä¸ªç»´åº¦</span></span><br><span class="line">    <span class="type">uint8_t</span> n_clauses;<span class="comment">//è¡¨æ˜è¯¥conjunction_idæ€»å…±æœ‰å‡ ä¸ªç»´åº¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Inserts &#x27;rule&#x27; into &#x27;cls&#x27;.  Until &#x27;rule&#x27; is removed from &#x27;cls&#x27;, the caller</span></span><br><span class="line"><span class="comment"> * must not modify or free it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;cls&#x27; must not contain an identical rule (including wildcards, values of</span></span><br><span class="line"><span class="comment"> * fixed fields, and priority).  Use classifier_find_rule_exactly() to find</span></span><br><span class="line"><span class="comment"> * such a rule. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">classifier_insert</span><span class="params">(<span class="keyword">struct</span> classifier *, <span class="type">const</span> <span class="keyword">struct</span> cls_rule *,</span></span><br><span class="line"><span class="params">                       <span class="type">ovs_version_t</span>, <span class="type">const</span> <span class="keyword">struct</span> cls_conjunction *,</span></span><br><span class="line"><span class="params">                       <span class="type">size_t</span> n_conjunctions)</span>;</span><br></pre></td></tr></table></figure>

<p>conjunctionæ˜¯å¯é€‰åŠŸèƒ½ï¼Œç”¨äºovsçš„conjunctionåŠŸèƒ½å®ç°</p>
<p>clsè§„åˆ™åŒ¹é…å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Finds and returns the highest-priority rule in &#x27;cls&#x27; that matches &#x27;flow&#x27; and</span></span><br><span class="line"><span class="comment"> * that is visible in &#x27;version&#x27;.  Returns a null pointer if no rules in &#x27;cls&#x27;</span></span><br><span class="line"><span class="comment"> * match &#x27;flow&#x27;.  If multiple rules of equal priority match &#x27;flow&#x27;, returns one</span></span><br><span class="line"><span class="comment"> * arbitrarily.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If a rule is found and &#x27;wc&#x27; is non-null, bitwise-OR&#x27;s &#x27;wc&#x27; with the</span></span><br><span class="line"><span class="comment"> * set of bits that were significant in the lookup.  At some point</span></span><br><span class="line"><span class="comment"> * earlier, &#x27;wc&#x27; should have been initialized (e.g., by</span></span><br><span class="line"><span class="comment"> * flow_wildcards_init_catchall()).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;flow&#x27; is non-const to allow for temporary modifications during the lookup.</span></span><br><span class="line"><span class="comment"> * Any changes are restored before returning.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;conj_flows&#x27; is an optional parameter.  If it is non-null, the matching</span></span><br><span class="line"><span class="comment"> * conjunctive flows are inserted. */</span></span><br><span class="line"><span class="type">const</span> <span class="keyword">struct</span> cls_rule *</span><br><span class="line"><span class="title function_">classifier_lookup</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> classifier *cls, <span class="type">ovs_version_t</span> version,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> flow *flow, <span class="keyword">struct</span> flow_wildcards *wc,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> hmapx *conj_flows)</span>;</span><br></pre></td></tr></table></figure>



<h2 id="CLSåº”ç”¨"><a href="#CLSåº”ç”¨" class="headerlink" title="CLSåº”ç”¨"></a>CLSåº”ç”¨</h2><h3 id="router"><a href="#router" class="headerlink" title="router"></a>router</h3><p>ä½¿ç”¨clsæ¥å­˜å‚¨<code>router</code>è§„åˆ™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ovs_router_entry</span> &#123;</span></span><br><span class="line">    <span class="comment">//routerè§„åˆ™ï¼ŒåŒ¹é…ç›®çš„ipåœ°å€å’Œpkt_mark</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cls_rule</span> <span class="title">cr</span>;</span></span><br><span class="line">    <span class="type">char</span> output_netdev[IFNAMSIZ];	<span class="comment">//å‡ºæ¥å£</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">gw</span>;</span>				<span class="comment">//ä¸‹ä¸€è·³ip</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">nw_addr</span>;</span>		<span class="comment">//ç›®çš„ip</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">src_addr</span>;</span>		<span class="comment">//æºipï¼Œæ˜¯å‡ºæ¥å£ä¸Šåœ°å€ï¼ˆovsè¿›è¡Œè·¯ç”±è½¬å‘æ—¶ï¼Œå¦‚æœæœªæŒ‡å®šæºipï¼Œåˆ™ä½¿ç”¨è¯¥ipä½œä¸ºæºã€‚æ¯”å¦‚æ„é€ éš§é“æµé‡æ—¶æœªæŒ‡å®šæºéš§é“ipï¼‰</span></span><br><span class="line">    <span class="type">uint8_t</span> plen;					<span class="comment">//å‰ç¼€æ©ç é•¿åº¦</span></span><br><span class="line">    <span class="type">uint8_t</span> priority;				<span class="comment">//plen+32ï¼Œè‹¥ä¸ºlocalè·¯ç”±ï¼Œåˆ™plen+64</span></span><br><span class="line">    <span class="type">bool</span> local;						<span class="comment">//æ˜¯å¦ä¸ºlocalè·¯ç”±</span></span><br><span class="line">    <span class="type">uint32_t</span> mark;					<span class="comment">//pkt_markï¼Œå¯ç”¨äºç­–ç•¥è·¯ç”±çš„å®ç°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p><strong>routerè§„åˆ™æ’å…¥</strong>ï¼š</p>
<p><code>router</code>è§„åˆ™æ·»åŠ æœ‰ä¸‹é¢ä¸¤ç§è§¦å‘æ–¹å¼ï¼š</p>
<ul>
<li><p>ç”±systemè§¦å‘ï¼šä½¿ç”¨netlinkå‘¨æœŸæ€§è·å–kernelçš„è·¯ç”±è¡¨ï¼Œè½¬æ¢ä¸º<code>router</code>è§„åˆ™å¹¶åŒæ­¥åˆ°clsä¸­</p>
</li>
<li><p>ç”±userè§¦å‘ï¼šä¸‹å‘<code>ovs-appctl ovs/route/add</code>å‘½ä»¤ï¼Œå°†è·¯ç”±ä¿¡æ¯è½¬æ¢ä¸º<code>router</code>è§„åˆ™å¹¶åŒæ­¥åˆ°clsä¸­</p>
</li>
</ul>
<p><strong>routerè§„åˆ™æŸ¥æ‰¾</strong>ï¼š</p>
<p>å½“slowpathæ‰§è¡ŒoutputåŠ¨ä½œæ—¶ï¼š</p>
<ul>
<li><p>å¦‚æœoutputæ¥å£ä¸ºtunnelæ¥å£ï¼ˆæ¯”å¦‚vxlanæ¥å£ï¼‰ï¼Œå¯¹flowè¿›è¡Œé¢„å¤„ç†</p>
<ul>
<li>å¦‚æœtunnelæ¥å£é…ç½®äº†local_ipï¼ˆéflowï¼‰ï¼Œè®¾ç½®éš§é“æºip</li>
<li>å¦‚æœtunnelæ¥å£é…ç½®äº†remote_ipï¼ˆéflowï¼‰ï¼Œè®¾ç½®éš§é“ç›®çš„ip</li>
<li>å¦‚æœtunnelæ¥å£é…ç½®äº†out_leyï¼ˆéflowï¼‰ï¼Œåˆ™è®¾ç½®vni</li>
<li>â€¦â€¦</li>
</ul>
</li>
<li><p>è‹¥é…ç½®äº†éš§é“æºipï¼Œå°†å…¶ä½œä¸ºç›®çš„ipè¿›è¡ŒrouteræŸ¥æ‰¾ï¼Œå¦‚æœæœªæ‰¾åˆ°æˆ–è€…æ‰¾åˆ°çš„è·¯ç”±è¡¨é¡¹ä¸æ˜¯localçš„ï¼Œåˆ™è·¯ç”±æŸ¥æ‰¾å¤±è´¥ã€‚ï¼ˆè¿™ä¸€æ­¥ä¿è¯äº†éš§é“æºipçš„æœ‰æ•ˆæ€§ï¼‰</p>
<blockquote>
<p>è·¯ç”±è¡¨é¡¹ä¸ºlocalçš„ï¼Œè¡¨æ˜è¯¥è·¯ç”±å¯é€å¾€æœ¬æœº</p>
</blockquote>
</li>
<li><p>è·å–éš§é“ç›®çš„ipè¿›è¡ŒrouteræŸ¥æ‰¾</p>
</li>
<li><p>è‹¥æ‰¾åˆ°è·¯ç”±è¡¨é¡¹ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®éš§é“æºipï¼Œåˆ™è®¾ç½®éš§é“æºipä¸ºè·¯ç”±è¡¨é¡¹çš„æºip</p>
</li>
<li><p>æ„å»ºéš§é“ä¿¡æ¯ï¼ˆå¤–å±‚å¤´æºç›®çš„macï¼Œå‡ºæ¥å£ï¼Œéš§é“ç±»å‹ç­‰ï¼‰ï¼Œè®¾ç½®fastpathçš„actionä¸ºtunnel_pushï¼Œç”±fastpathè¿›è¡Œéš§é“çš„å°è£…</p>
</li>
</ul>
<h3 id="tnlï¼ˆtunnelï¼‰"><a href="#tnlï¼ˆtunnelï¼‰" class="headerlink" title="tnlï¼ˆtunnelï¼‰"></a>tnlï¼ˆtunnelï¼‰</h3><p>ä½¿ç”¨clsæ¥å­˜å‚¨<code>tnl_port_map</code>è§„åˆ™ï¼Œè¯¥è§„åˆ™æ˜¯æ ¹æ®ä¸‹é¢ä¸¤ä¸ªé“¾è¡¨ä¸­çš„ä¿¡æ¯ç›¸äº’ç»„åˆæ‰€å½¢æˆçš„</p>
<ul>
<li><p>addr_listï¼šå­˜å‚¨ç€æ‰€æœ‰è·¯ç”±å‡ºæ¥å£çš„ipå’Œmacä¿¡æ¯ï¼ˆå‡ºæ¥å£ä¸€èˆ¬ä¸ºæ¡¥æ¥å£ï¼‰</p>
</li>
<li><p>port_listï¼šå­˜å‚¨ç€æ‰€æœ‰çš„tunnelæ¥å£ä¿¡æ¯ï¼ˆåŒ…æ‹¬tunnelçš„l4åè®®ï¼Œl4ç›®çš„ç«¯å£ï¼‰</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tnl_port_in</span> &#123;</span></span><br><span class="line">    <span class="comment">//tnl_port_mapè§„åˆ™ï¼ŒåŒ¹é…ä¸‹é¢çš„flowå­—æ®µï¼š</span></span><br><span class="line">    <span class="comment">//ç›®çš„macã€ç›®çš„ipï¼ˆaddr_listä¸­è·å–ï¼‰</span></span><br><span class="line">    <span class="comment">//l4åè®®å·åŠl4ç›®çš„ç«¯å£ï¼ˆport_listä¸­è·å–ï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cls_rule</span> <span class="title">cr</span>;</span></span><br><span class="line">    <span class="type">odp_port_t</span> portno;			<span class="comment">//tunnelæ¥å£çš„id</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_refcount</span> <span class="title">ref_cnt</span>;</span></span><br><span class="line">    <span class="type">char</span> dev_name[IFNAMSIZ];	<span class="comment">//tunnelæ¥å£åç§°ï¼Œshowå‘½ä»¤ç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>tnl_port_mapè§„åˆ™æ’å…¥</strong>ï¼š</p>
<p><code>tnl_port_map</code>è§„åˆ™æ·»åŠ æœ‰ä¸‹é¢ä¸¤ç§è§¦å‘æ–¹å¼ï¼š</p>
<ul>
<li><p>æ·»åŠ è·¯ç”±æ—¶ï¼Œå°†è·¯ç”±å‡ºæ¥å£ä¿¡æ¯ï¼ˆipã€macï¼‰æ›´æ–°åˆ°<code>addr_list</code>ä¸­ï¼Œè§¦å‘<code>tnl_port_map</code>è§„åˆ™çš„æ›´æ–°</p>
</li>
<li><p>æ·»åŠ tnlæ¥å£æ—¶ï¼Œå°†tnlæ¥å£ä¿¡æ¯ï¼ˆl4 proto_noï¼Œ l4 dst_portï¼‰æ›´æ–°åˆ°<code>port_list</code>ä¸­ï¼Œè§¦å‘<code>tnl_port_map</code>è§„åˆ™çš„æ›´æ–°</p>
</li>
</ul>
<p><strong>tnl_port_mapè§„åˆ™æŸ¥æ‰¾</strong>ï¼š</p>
<p>å½“slowpathæ‰§è¡ŒoutputåŠ¨ä½œæ—¶ï¼š</p>
<ul>
<li><p>å¦‚æœoutputæ¥å£å­˜åœ¨ipï¼ˆæ¯”å¦‚LOCALï¼‰ï¼Œä¸”å­˜åœ¨tunnelå£ï¼Œåˆ™è¿›è¡Œ<code>tnl_port_map</code>æŸ¥æ‰¾</p>
</li>
<li><p>æŸ¥æ‰¾åˆ°å¯¹åº”çš„<code>tnl_port_map</code>è§„åˆ™ï¼Œè¯´æ˜æ˜¯éš§é“æµé‡ï¼Œè®¾ç½®fastpathçš„actionä¸ºtunnel_popï¼Œç”±fastpathè¿›è¡Œéš§é“çš„è§£å°è£…</p>
</li>
</ul>
<h3 id="openflow-table"><a href="#openflow-table" class="headerlink" title="openflow table"></a>openflow table</h3><p>ä½¿ç”¨clsæ¥å®ç°openflow table</p>
<h2 id="CLSåŸç†"><a href="#CLSåŸç†" class="headerlink" title="CLSåŸç†"></a>CLSåŸç†</h2><p>clsä¸»è¦æ˜¯åˆ©ç”¨hashè¡¨æ¥è¿›è¡Œè§„åˆ™çš„æ’å…¥å’ŒæŸ¥æ‰¾ã€‚</p>
<p><strong>clsè§„åˆ™åˆ†ä¸ºä¸‰éƒ¨åˆ†ç»„æˆ</strong>ï¼š</p>
<ul>
<li>cls_flowï¼šè®°å½•è§„åˆ™åŒ¹é…çš„å†…å®¹</li>
<li>cls_maskï¼šè®°å½•è§„åˆ™æ„Ÿå…´è¶£çš„åŒ¹é…é¡¹</li>
<li>cls_priorityï¼šè®°å½•è§„åˆ™ä¼˜å…ˆçº§</li>
</ul>
<p>å½“ä¸€ä¸ªflowé€å…¥clsä¸­è¿›è¡Œè§„åˆ™åŒ¹é…æ—¶ï¼Œé¦–å…ˆéœ€è¦å°†flowä¸clsè§„åˆ™ä¸­çš„<code>cls_mask</code>ç›¸ä¸ï¼Œå¾—åˆ°çš„åŒ¹é…ä¸²å†ä¸<code>cls_flow &amp; cls_mask</code>è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™å‘½ä¸­è¯¥è§„åˆ™ï¼Œè‹¥ä¸ç›¸ç­‰ï¼Œåˆ™æœªå‘½ä¸­è¯¥è§„åˆ™ã€‚</p>
<p>ç”±äºè§„åˆ™åŒ¹é…æ—¶ï¼Œflowå¿…é¡»ä¸<code>cls_mask</code>ç›¸ä¸åæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥åŒ¹é…ï¼Œæ‰€ä»¥clså°†clsè§„åˆ™æŒ‰ç…§<code>cls_mask</code>åˆ†åˆ°ä¸åŒçš„ç»„ä¸­ã€‚è¿™æ ·ï¼Œæ¯ç»„ä¸­çš„<code>cls_mask</code>éƒ½ç›¸åŒï¼Œflowåªéœ€è¦ä¸<code>cls_mask</code>ç›¸ä¸ä¸€æ¬¡ï¼Œå°±å¯ä»¥ä¸è¯¥ç»„ä¸­æ‰€æœ‰çš„clsè§„åˆ™è¿›è¡Œæ¯”è¾ƒäº†ã€‚è¿™ä¸ªç»„åœ¨clsä¸­è¢«ç§°ä¸ºsubtableã€‚</p>
<p><strong>subtableæ„æˆ</strong>ï¼š</p>
<ul>
<li>max_priorityï¼šè¡¨ç¤ºè¯¥subtableä¸­ä¼˜å…ˆçº§æœ€é«˜çš„è§„åˆ™çš„ä¼˜å…ˆçº§</li>
<li>index_mapsï¼šæ•´ä¸ªæ•°ç»„å­˜å‚¨ç€è¯¥subtableçš„maskï¼ˆè‡³äºä¸ºä»€ä¹ˆä½¿ç”¨æ•°ç»„å­˜ï¼Œåé¢çš„åˆ†æ®µhashåŒ¹é…æœ‰è®²åˆ°ï¼‰</li>
<li>rulesï¼šhashè¡¨ï¼Œkeyä¸º<code>cls_flow &amp; cls_mask</code>çš„hashå€¼ï¼Œvalueä¸ºclsè§„åˆ™</li>
</ul>
<p>ä¸‹é¢æ˜¯clsä¸­subtableçš„å…·ä½“å®ç°ï¼Œå…¶å¤§éƒ¨åˆ†å­—æ®µä¸ºä¹‹åæ‰€ä»‹ç»çš„æ©ç ä¼˜åŒ–æ‰€ç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cls_subtable</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmap_node</span> <span class="title">cmap_node</span>;</span>    <span class="comment">/* Within classifier&#x27;s &#x27;subtables_map&#x27;. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These fields are only used by writers. */</span></span><br><span class="line">    <span class="type">int</span> max_priority;              <span class="comment">/* Max priority of any rule in subtable. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> max_count;        <span class="comment">/* Count of max_priority rules. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Accessed by iterators. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rculist</span> <span class="title">rules_list</span>;</span>              <span class="comment">/* Unordered. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Identical, but lower priority rules are not inserted to any of the</span></span><br><span class="line"><span class="comment">     * following data structures. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These fields are accessed by readers who care about wildcarding. */</span></span><br><span class="line">    <span class="comment">//subtableå°†mask_flowåˆ†ä¸ºå¤šä¸ªä¸ä¸º0çš„åˆ†æ®µæ©ç ï¼Œæ¯ä¸ªåˆ†æ®µæ©ç å¯¹åº”ä¸€ä¸ªindex_maps</span></span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾æ—¶æŒ‰ç…§åˆ†æ®µæ©ç è¿›è¡Œåˆ†æ®µhashæŸ¥æ‰¾ï¼Œè¯¥å­—æ®µå°±è¡¨æ˜äº†è¯¥subtableéœ€è¦è¿›è¡Œå‡ æ¬¡çš„åˆ†æ®µæŸ¥æ‰¾</span></span><br><span class="line">    <span class="comment">//(è¿™é‡Œçš„æŸ¥æ‰¾æ¬¡æ•°ä¸ºåˆ†æ®µæ©ç ä¸ªæ•°-1)</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span> n_indices;                   <span class="comment">/* How many indices to use. */</span></span><br><span class="line">    <span class="comment">//å­˜å‚¨åˆ†æ®µæ©ç </span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">flowmap</span> <span class="title">index_maps</span>[<span class="title">CLS_MAX_INDICES</span> + 1];</span> <span class="comment">/* Stage maps. */</span></span><br><span class="line">    <span class="comment">//è¯¥subtableçš„maskåœ¨trieæ ‘çš„å‰ç¼€æ©ç é•¿åº¦ï¼Œå¦‚æœä¸æ˜¯å‰ç¼€æ©ç ï¼Œåˆ™ä¸º0ï¼Œè¯¥trieä¸ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> trie_plen[CLS_MAX_TRIES];  <span class="comment">/* Trie prefix length in &#x27;mask&#x27;</span></span><br><span class="line"><span class="comment">                                             * (runtime configurable). */</span></span><br><span class="line">    <span class="comment">//l4å±‚çš„port_src + port_dst</span></span><br><span class="line">    <span class="comment">//å› ä¸ºå‰ç¼€æ©ç å¯èƒ½ä¸è¿ç»­ï¼Œå› æ­¤åœ¨æ’å…¥å’ŒåŒ¹é…æ—¶ä¸æ©ç ç›¸ä¸ï¼Œä¿è¯trieçš„æ­£ç¡®æ€§</span></span><br><span class="line">    <span class="comment">//å‰ç¼€é•¿åº¦ä¸ºMSBåˆ°LSB setä¹‹é—´é•¿åº¦ï¼ˆä¾‹ï¼š0b001000çš„å‰ç¼€é•¿åº¦ä¸º3ï¼‰</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> ports_mask_len;</span><br><span class="line">    <span class="comment">//ç”¨äºå­˜å‚¨åˆ†æ®µhashï¼Œæ¯ä¸ªåˆ†æ®µæ‰€è®¡ç®—å‡ºæ¥çš„hashå€¼åŒ…å«å‰é¢åˆ†æ®µçš„éƒ¨åˆ†çš„hashå€¼</span></span><br><span class="line">    <span class="comment">//å› æ­¤æœ€åä¸€ä¸ªåˆ†æ®µçš„hashå€¼åœ¨è¿™é‡Œå¹¶æ²¡æœ‰å­˜å‚¨ï¼Œå› ä¸ºæœ€åä¸€ä¸ªåˆ†æ®µçš„hashå€¼å°±æ˜¯æ•´ä¸ªminiflowçš„hashå€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ccmap</span> <span class="title">indices</span>[<span class="title">CLS_MAX_INDICES</span>];</span>  <span class="comment">/* Staged lookup indices. */</span></span><br><span class="line">    <span class="comment">//portçš„æ©ç å¯èƒ½éå‰ç¼€ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ’å…¥å’ŒåŒ¹é…çš„æ•°æ®ä¸æ©ç ç›¸ä¸ï¼Œä¿è¯éå‰ç¼€æ©ç ä¸ä¼šå½±å“åˆ°trieçš„ä½¿ç”¨</span></span><br><span class="line">    rcu_trie_ptr ports_trie;                <span class="comment">/* NULL if none. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These fields are accessed by all readers. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmap</span> <span class="title">rules</span>;</span>                      <span class="comment">/* Contains &#x27;cls_match&#x27;es. */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">minimask</span> <span class="title">mask</span>;</span>             <span class="comment">/* Wildcards for fields. */</span></span><br><span class="line">    <span class="comment">/* &#x27;mask&#x27; must be the last field. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>clsè§„åˆ™æ’å…¥æµç¨‹</strong>ï¼š</p>
<ul>
<li>æ ¹æ®cls_maskæŸ¥æ‰¾å¯¹åº”çš„subtableï¼Œè‹¥æœªæ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„subtable</li>
<li>è‹¥æ‰¾åˆ°subtableï¼Œåˆ™è®¡ç®—è¯¥clsçš„hashå€¼ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°subtableä¸­ã€‚å¦‚æœè¯¥clsè§„åˆ™æ˜¯è¯¥subtableä¸­ä¼˜å…ˆçº§æœ€é«˜çš„è§„åˆ™ï¼Œåˆ™æ›´æ–°subtableçš„<code>max_priority</code></li>
</ul>
<p><strong>clsåŒ¹é…æµç¨‹</strong>ï¼š</p>
<ul>
<li>è®¾ç½®local_priorityä¸ºæœ€å°</li>
<li>æŒ‰ç…§ä¼˜å…ˆçº§ä»é«˜åˆ°ä½éå†subtableï¼Œå…¶ä¸­subtableçš„æœ€å°ä¼˜å…ˆçº§è¦å¤§äºlocal_priority</li>
<li>å°†å¾…åŒ¹é…çš„flowè·Ÿsubtableçš„maskç›¸ä¸ï¼Œè€Œåè®¡ç®—hashå€¼ï¼Œåœ¨<code>rules</code>ä¸­è¿›è¡ŒhashæŸ¥æ‰¾</li>
<li>è‹¥æ‰¾åˆ°è§„åˆ™ï¼Œä¸”ä¼˜å…ˆçº§æ¯”local_priorityå¤§ï¼Œåˆ™è®°å½•æ‰€å‘½ä¸­çš„clsè§„åˆ™ï¼Œæ›´æ–°local_priorityä¸ºæ‰€å‘½ä¸­çš„clsè§„åˆ™çš„ä¼˜å…ˆçº§</li>
<li>è·³åˆ°ç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ²¡æœ‰å¯è®¿é—®çš„subtableä¸ºæ­¢</li>
<li>æ­¤æ—¶æ‰€è®°å½•çš„clsè§„åˆ™ä¸ºæœ€ç»ˆæ‰€å‘½ä¸­çš„clsè§„åˆ™</li>
</ul>
<h3 id="æ©ç ä¼˜åŒ–"><a href="#æ©ç ä¼˜åŒ–" class="headerlink" title="æ©ç ä¼˜åŒ–"></a>æ©ç ä¼˜åŒ–</h3><p>ä¸»è¦ç”¨äºè§„åˆ™åŒ¹é…å¤±è´¥æ—¶wcæ©ç çš„è®¾ç½®ï¼ˆåŸºäºsubtableçš„ï¼Œå› ä¸ºè¯¥flowå¯èƒ½åœ¨æŸä¸ªä½ä¼˜å…ˆçº§çš„subtableä¸­å‘½ä¸­ï¼Œè€Œåœ¨æ¯”ä»–é«˜ä¼˜å…ˆçº§çš„subtableä¸­æœªå‘½ä¸­ï¼‰ã€‚</p>
<h4 id="åˆ†æ®µhashåŒ¹é…"><a href="#åˆ†æ®µhashåŒ¹é…" class="headerlink" title="åˆ†æ®µhashåŒ¹é…"></a>åˆ†æ®µhashåŒ¹é…</h4><p>æ ¹æ®flowç»“æ„ä½“çš„æˆå‘˜åˆ†å¸ƒï¼Œå°†flowåˆ†ä¸º4æ®µï¼š</p>
<ul>
<li>Metadataæ•°æ®æ®µ</li>
<li>L2æ•°æ®æ®µ</li>
<li>L3æ•°æ®æ®µ</li>
<li>L4æ•°æ®æ®µ</li>
</ul>
<p>åœ¨subtableåˆ›å»ºæ—¶ï¼Œå°†è¯¥subtableçš„æ©ç æŒ‰ç…§ä¸Šé¢çš„æè¿°åˆ†ä¸ºnæ®µï¼ˆè·³è¿‡æ©ç ä¸º0çš„æ•°æ®æ®µï¼Œæœ€å¤š4æ®µï¼‰ï¼Œå­˜åˆ°<code>index_maps</code>ä¸­</p>
<p><strong>è§„åˆ™æ’å…¥æ—¶</strong>ï¼š</p>
<ul>
<li>æ ¹æ®è§„åˆ™çš„maskæ‰¾åˆ°å¯¹åº”çš„subtable</li>
<li>ä¾æ¬¡è®¡ç®—å‰næ®µçš„hashï¼Œå¹¶æ’å…¥åˆ°<code>indices</code>ä¸­ï¼ˆè¿™é‡Œä¸åŒ…æ‹¬æœ€åä¸€æ®µï¼Œå› ä¸ºåŒ…æ‹¬äº†æœ€åä¸€æ®µå°±æ˜¯æ•´ä¸ªflowçš„hashï¼Œè€Œè¿™ä¸ªhashå€¼å·²ç»ä½œä¸ºkeyè¢«æ’å…¥åˆ°subtableçš„<code>rules</code>ä¸­ï¼‰</li>
</ul>
<p><strong>è§„åˆ™æŸ¥æ‰¾æ—¶</strong>ï¼š</p>
<ul>
<li>æ ¹æ®flowçš„maskæ‰¾åˆ°å¯¹åº”çš„subtable</li>
<li>é€šè¿‡å‰ç¼€åŸŸæ£€æŸ¥ï¼ˆä¼˜åŒ–2ï¼‰</li>
<li>æ ¹æ®è¯¥subtableçš„åˆ†æ®µæ©ç ï¼Œè®¡ç®—è¯¥flowå‰næ®µæ©ç åçš„hashï¼Œå¹¶åœ¨<code>indices</code>ä¸­æŸ¥æ‰¾<ul>
<li>è‹¥æŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™å°†wcè®¾ç½®ä¸ºè¯¥subtableå‰næ®µçš„æ©ç </li>
<li>è‹¥æŸ¥æ‰¾æˆåŠŸï¼Œåˆ™å°†wcè®¾ç½®ä¸ºè¯¥subtableçš„æ©ç ï¼Œå¹¶è¿”å›å‘½ä¸­çš„clsè§„åˆ™</li>
</ul>
</li>
</ul>
<h4 id="å‰ç¼€åŸŸåŒ¹é…"><a href="#å‰ç¼€åŸŸåŒ¹é…" class="headerlink" title="å‰ç¼€åŸŸåŒ¹é…"></a>å‰ç¼€åŸŸåŒ¹é…</h4><h5 id="å‰ç½®çŸ¥è¯†ï¼ˆBinary-trieï¼‰"><a href="#å‰ç½®çŸ¥è¯†ï¼ˆBinary-trieï¼‰" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼ˆBinary trieï¼‰"></a>å‰ç½®çŸ¥è¯†ï¼ˆBinary trieï¼‰</h5><p>å‰ç¼€äºŒå‰æ ‘ï¼Œä¸€ç§ç”¨äºå¿«é€Ÿæ£€ç´¢çš„äºŒå‰æ ‘ç»“æ„ï¼Œå…¶åŸºæœ¬æ€§è´¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>èŠ‚ç‚¹å­˜å‚¨æœ€å¤š32ä½çš„å‰ç¼€ä¿¡æ¯å’Œè¯¥èŠ‚ç‚¹å¯å‘½ä¸­çš„è§„åˆ™æ•°</li>
<li>èŠ‚ç‚¹æŒ‡å‘å·¦å­©å­çš„è¾¹ä»£è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯çš„æœ€é«˜ä½ä¸º0ï¼ŒæŒ‡å‘å³å­©å­çš„è¾¹ä»£è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯çš„æœ€é«˜ä½ä¸º1</li>
<li>æ ¹èŠ‚ç‚¹ä¸­çš„å‰ç¼€ä¿¡æ¯ä¸ºå‰ç¼€ä¸²çš„ç¬¬ä¸€ä½ä¸ºMSBï¼Œå¶èŠ‚ç‚¹ä¸­çš„å‰ç¼€ä¿¡æ¯çš„æœ€åä¸€ä½ä¸ºLSB</li>
<li>æ ¹èŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯å¯èƒ½ä¸ºç©º</li>
<li>ä»æ ¹èŠ‚ç‚¹åˆ°æŸä¸€ç»“ç‚¹ï¼Œè·¯å¾„ä¸Šç»è¿‡èŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯è¿æ¥èµ·æ¥ï¼Œä¸ºè¯¥èŠ‚ç‚¹å¯¹åº”çš„å®Œæ•´çš„å‰ç¼€ä¸²</li>
</ul>
<p>ä¾‹ï¼šæ·»åŠ ä¸‰æ¡è§„åˆ™åˆ°trieä¸­</p>
<table>
<thead>
<tr>
<th>rule1</th>
<th>rule2</th>
<th>rule3</th>
</tr>
</thead>
<tbody><tr>
<td>0b1011&#x2F;0b1111</td>
<td>0b1011&#x2F;0b1000</td>
<td>0b0100&#x2F;0b1100</td>
</tr>
</tbody></table>
<p>æ„å»ºçš„binary trieå¦‚ä¸‹ï¼š</p>
<p><a href="/images/binary_trie.svg" title="binary_trie" class="gallery-item" style="box-shadow: none;"> <img src="/images/binary_trie.svg" alt="binary_trie"></a></p>
<h5 id="è‡ªå®šä¹‰å‰ç¼€åŸŸ"><a href="#è‡ªå®šä¹‰å‰ç¼€åŸŸ" class="headerlink" title="è‡ªå®šä¹‰å‰ç¼€åŸŸ"></a>è‡ªå®šä¹‰å‰ç¼€åŸŸ</h5><p>é€šè¿‡APIæ¥è®¾ç½®clsçš„trieï¼Œåœ¨è§„åˆ™åŒ¹é…æ—¶ç”¨äºç”ŸæˆåŒ¹é…å¤±è´¥çš„wcã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//clsè‡ªå®šä¹‰å‰ç¼€åŸŸè®¾ç½®ï¼Œè¿™äº›å‰ç¼€åŸŸå¯ä»¥ä½¿å¾—åŒ¹é…åæ‰€ç”Ÿæˆçš„æ©ç æ›´å°ï¼Œä¿è¯äº†æ‰€ä¸‹å‘çš„fastpathè§„åˆ™å°½å¯èƒ½çš„èšåˆã€‚</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">classifier_set_prefix_fields</span><span class="params">(<span class="keyword">struct</span> classifier *,</span></span><br><span class="line"><span class="params">                                  <span class="type">const</span> <span class="keyword">enum</span> mf_field_id *trie_fields,</span></span><br><span class="line"><span class="params">                                  <span class="type">unsigned</span> <span class="type">int</span> n_trie_fields)</span>;</span><br></pre></td></tr></table></figure>

<p>trieæ˜¯åŸºäºclsçš„ï¼Œæ¯ä¸ªtrieå¯¹åº”ä¸€ä¸ªmeta-flow fieldï¼Œç›®å‰æœ€å¤šæ”¯æŒ4ä¸ªtrieï¼Œä¸€èˆ¬ä¸º<code>ipv4_srcã€ipv4_dstã€ipv6_srcã€ipv6_dst</code>ã€‚</p>
<blockquote>
<p>trieæ‰€å¯¹åº”çš„fieldåœ¨è§„åˆ™ä¸­ä¸€å®šè¦ä½¿ç”¨å‰ç¼€æ©ç ï¼Œå¦åˆ™è¯¥è§„åˆ™æ‰€å¤„çš„subtableä¸­çš„trieçš„å‰ç¼€é•¿åº¦ä¸º0ï¼Œæ— æ³•ç”Ÿæˆèšåˆçš„wc</p>
</blockquote>
<p><strong>è§„åˆ™æ’å…¥æ—¶å¯¹trieçš„æ“ä½œ</strong>ï¼š</p>
<ul>
<li>æ ¹æ®è§„åˆ™çš„maskï¼ŒæŸ¥æ‰¾å¯¹åº”çš„subtableã€‚subtableä¸­å­˜å‚¨ç€è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼ˆå› ä¸ºsubtableä¸­æ‰€æœ‰çš„è§„åˆ™çš„æ©ç éƒ½ç›¸åŒï¼Œæ‰€ä»¥trieçš„å‰ç¼€é•¿åº¦æ˜¯ç”±subtableå­˜å‚¨ï¼‰</li>
<li>æ ¹æ®subtableä¸­å¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼Œè·å–è¯¥è§„åˆ™å¯¹åº”å‰ç¼€åŸŸçš„å‰ç¼€ä¸²ï¼Œå¹¶æ’å…¥trieä¸­</li>
</ul>
<p><strong>è§„åˆ™åŒ¹é…æ—¶å¯¹trieçš„æ“ä½œ</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Prefix tree context.  Valid when &#x27;lookup_done&#x27; is true.  Can skip all</span></span><br><span class="line"><span class="comment"> * subtables which have a prefix match on the trie field, but whose prefix</span></span><br><span class="line"><span class="comment"> * length is not indicated in &#x27;match_plens&#x27;.  For example, a subtable that</span></span><br><span class="line"><span class="comment"> * has a 8-bit trie field prefix match can be skipped if</span></span><br><span class="line"><span class="comment"> * !be_get_bit_at(&amp;match_plens, 8 - 1).  If skipped, &#x27;maskbits&#x27; prefix bits</span></span><br><span class="line"><span class="comment"> * must be unwildcarded to make datapath flow only match packets it should. */</span></span><br><span class="line"><span class="comment">//è§„åˆ™åŒ¹é…æ—¶æ‰€ä½¿ç”¨çš„trieçš„ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trie_ctx</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cls_trie</span> *<span class="title">trie</span>;</span></span><br><span class="line">    <span class="type">bool</span> lookup_done;        <span class="comment">/* Status of the lookup. */</span></span><br><span class="line">    <span class="comment">//å¯¹flowçš„fieldä»…éœ€è¦åŒ¹é…maskbitsé•¿åº¦çš„å‰ç¼€å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„åŒ¹é…ç»“æœ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> maskbits;   <span class="comment">/* Prefix length needed to avoid false matches. */</span></span><br><span class="line">    <span class="comment">//è®°å½•è¯¥flowæ‰€å‘½ä¸­çš„å‰ç¼€é•¿åº¦ï¼Œç¬¬nä½ä¸º1è¡¨ç¤ºå‘½ä¸­äº†å‰ç¼€é•¿åº¦ä¸ºn+1çš„è§„åˆ™ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">trie_prefix</span> <span class="title">match_plens</span>;</span>  <span class="comment">/* Bitmask of prefix lengths with possible</span></span><br><span class="line"><span class="comment">                                     * matches. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>æ ¹æ®trieæ‰€å¯¹åº”çš„å‰ç¼€åŸŸï¼Œä»å¾…åŒ¹é…çš„flowä¸­æå–è¯¥å­—æ®µæ‰€å¯¹åº”çš„åŒ¹é…ä¸²</p>
</li>
<li><p>å°†è¯¥åŒ¹é…ä¸²é€å…¥trieä¸­è¿›è¡ŒåŒ¹é…ï¼Œå°†åŒ¹é…ç»“æœå­˜åœ¨<code>trie_ctx</code>ä¸­</p>
</li>
<li><p>åˆ¤æ–­æ˜¯å¦å¯èƒ½å‘½ä¸­äº†è¯¥subtableä¸­çš„è§„åˆ™ï¼ˆè®¾è¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ä¸ºnï¼‰ï¼šä¹Ÿå°±æ˜¯åˆ¤æ–­<code>match_plens</code>çš„ç¬¬n-1ä½æ˜¯å¦ä¸º1ã€‚è‹¥ä¸º1ï¼Œåˆ™è¯´æ˜å¯èƒ½å‘½ä¸­äº†è¯¥subtableçš„è§„åˆ™ï¼Œè‹¥ä¸º0ï¼Œåˆ™è¯´æ˜ä¸€å®šæ²¡æœ‰å‘½ä¸­è¯¥subtableçš„è§„åˆ™</p>
<blockquote>
<p> è¿™é‡Œè¯´å¯èƒ½å‘½ä¸­ï¼Œæ˜¯å› ä¸ºä¸åŒsubtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å¯èƒ½ç›¸åŒï¼Œè‹¥ä¸º1ï¼Œä¹Ÿå¯èƒ½å‘½ä¸­äº†å…¶ä»–subtableä¸­çš„è§„åˆ™</p>
</blockquote>
<ul>
<li><p>è‹¥å¯èƒ½å‘½ä¸­è¯¥subtableä¸­çš„è§„åˆ™ï¼šä¸åšä»»ä½•æ“ä½œã€‚å› ä¸ºtrieåªå¯¹æœªå‘½ä¸­è§„åˆ™çš„wcåšä¼˜åŒ–ã€‚</p>
</li>
<li><p>è‹¥æœªå‘½ä¸­è¯¥subtableä¸­çš„è§„åˆ™ï¼š</p>
<ul>
<li><p>å¦‚æœè¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å¤§äºç­‰äºmaskbitsï¼Œåˆ™è®¾ç½®wcä¸­å¯¹åº”trieçš„å‰ç¼€åŸŸçš„å‰ç¼€æ©ç ï¼Œæ©ç é•¿åº¦ä¸º<code>maskbits</code>ã€‚å¹¶è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚</p>
<blockquote>
<p>å› ä¸ºmaskbitsé•¿åº¦çš„æ©ç å·²ç»èƒ½ç¡®å®šäº†å¯¹äºè¯¥fieldï¼Œflowå’Œwcæ©ç åä¸€å®šæ²¡æœ‰å‘½ä¸­è¯¥subtableçš„è§„åˆ™ã€‚</p>
<p>ä½†ä¸ºä»€ä¹ˆè¦å¯¹wcè®¾ç½®maskbitsçš„å‰ç¼€é•¿åº¦ï¼Œè€Œä¸æ˜¯subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å‘¢ï¼Ÿ</p>
</blockquote>
</li>
<li><p>å¦‚æœè¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å°äº<code>maskbits</code>ï¼Œåˆ™åˆ¤æ–­wcä¸­æ˜¯å¦è®¾ç½®äº†æ©ç é•¿åº¦ä¸º<code>maskbits</code>çš„æ©ç ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚å¦‚æœæ²¡è®¾ç½®ï¼Œåˆ™ç»§ç»­è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚</p>
<blockquote>
<p>å½“subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å°äºmaskbitsæ—¶ï¼Œä¸ºä»€ä¹ˆä¸è®¾ç½®wcä¸ºsubtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼Œå¹¶è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…å‘¢ï¼Ÿè¿™æ ·åšä¸æ˜¯èƒ½è¾¾åˆ°æ©ç çš„æœ€å°åŒ–å—ï¼Ÿä¸ç†è§£</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>ä¸ªäººè®¤ä¸ºï¼Œå½“trieè‹¥æœªå‘½ä¸­è¯¥subtableä¸­çš„è§„åˆ™æ—¶ï¼Œç›´æ¥å¯¹wcè®¾ç½®è¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼Œå¹¶è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚maskbitsä¸å†éœ€è¦ã€‚</p>
</blockquote>
<h5 id="å†…ç½®l4-portå‰ç¼€åŸŸ"><a href="#å†…ç½®l4-portå‰ç¼€åŸŸ" class="headerlink" title="å†…ç½®l4 portå‰ç¼€åŸŸ"></a>å†…ç½®l4 portå‰ç¼€åŸŸ</h5><p>ä¸ä¼˜åŒ–2ç±»ä¼¼ï¼Œä½¿ç”¨trieæ„å»ºï¼Œå› ä¸ºportçš„å‰ç¼€æ©ç å¯èƒ½ä¸è¿ç»­ï¼Œå› æ­¤åœ¨æ’å…¥å’ŒåŒ¹é…æ—¶ä¸æ©ç ç›¸ä¸ï¼Œä¿è¯trieçš„æ­£ç¡®æ€§ã€‚l4 portçš„å‰ç¼€é•¿åº¦ä¸º<strong>MSB</strong>åˆ°<strong>LSB 1</strong>ä¹‹é—´é•¿åº¦ï¼ˆ0b001000çš„å‰ç¼€é•¿åº¦ä¸º3ï¼‰</p>
<p>è¯¥port_trieæ˜¯åŸºäºsubtableçš„ã€‚åœ¨subtableä¸­ï¼Œå¯¹è¯¥flowè¿›è¡Œå…¨é‡åŒ¹é…åï¼Œä»æœªå‘½ä¸­è§„åˆ™ï¼Œåˆ™å¯¹è¯¥port_trieè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ ¹æ®æŸ¥æ‰¾ç»“æœç¡®å®š<code>port_mask</code>ï¼Œå¹¶å°†å…¶è®¾ç½®åˆ°wcçš„l4 portå‰ç¼€åŸŸä¸­ã€‚</p>
<p><strong>è§„åˆ™æ’å…¥æ—¶å¯¹port_trieçš„æ“ä½œ</strong>ï¼š</p>
<ul>
<li>æ ¹æ®è§„åˆ™çš„maskï¼ŒæŸ¥æ‰¾å¯¹åº”çš„subtableã€‚subtableä¸­å­˜å‚¨ç€è¯¥port_trieåŠport_trieçš„å‰ç¼€é•¿åº¦</li>
<li>æ ¹æ®subtableä¸­å¯¹è¯¥port_trieçš„å‰ç¼€é•¿åº¦ï¼Œè·å–è¯¥è§„åˆ™ä¸­l4 portçš„å‰ç¼€ä¸²ï¼ˆ<code>[port_src, port_dst] &amp; cls_mask</code>ï¼‰ï¼Œå¹¶æ’å…¥trieä¸­</li>
</ul>
<p><strong>è§„åˆ™åŒ¹é…æ—¶å¯¹port_trieçš„æ“ä½œ</strong>ï¼š</p>
<ul>
<li>å½“subtableå¯¹è¯¥flowè¿›è¡Œå…¨é‡åŒ¹é…ä¸”æœªå‘½ä¸­åï¼Œæå–flowçš„portä¿¡æ¯ï¼ˆ<code>[port_src, port_dst] &amp; subtable_mask</code>ï¼‰ï¼Œåœ¨port_trieä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¹¶è¿”å›åŒ¹é…é•¿åº¦ï¼ˆè¿™ä¸ªåŒ¹é…é•¿åº¦è·Ÿtrie_ctxä¸­çš„<code>maskbits</code>ä¸€ä¸ªå«ä¹‰ï¼‰</li>
<li>å°†è¿™ä¸ªé•¿åº¦ä½œä¸ºå‰ç¼€æ©ç é•¿åº¦ï¼Œå¹¶è®¾ç½®åˆ°wcçš„l4 portä¸­</li>
</ul>
<h3 id="è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶"><a href="#è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶" class="headerlink" title="è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶"></a>è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶</h3><p>ç‰ˆæœ¬å·å¯æ§åˆ¶clsä¸­çš„clsè§„åˆ™æ˜¯å¦å¯¹ç”¨æˆ·å¯è§ï¼Œåœ¨clsè§„åˆ™æ’å…¥å’Œclsè§„åˆ™åŒ¹é…æ—¶ï¼Œéƒ½ä¼šå¸¦æœ‰å½“å‰ç‰ˆæœ¬å·ä¿¡æ¯ã€‚ç‰ˆæœ¬å·çš„æ§åˆ¶æ˜¯ä»¥clsè§„åˆ™ä¸ºå•ä½çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡APIå¯¹ç‰¹å®šçš„è§„åˆ™çš„ç‰ˆæœ¬å·è¿›è¡Œæ§åˆ¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">versions</span> &#123;</span></span><br><span class="line">    <span class="type">ovs_version_t</span> add_version;              <span class="comment">/* Version object was added in. */</span></span><br><span class="line">    ATOMIC(<span class="type">ovs_version_t</span>) remove_version;   <span class="comment">/* Version object is removed in. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Makes &#x27;rule&#x27; invisible in &#x27;remove_version&#x27;.  Once that version is used in</span></span><br><span class="line"><span class="comment"> * lookups, the caller should remove &#x27;rule&#x27; via ovsrcu_postpone().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;rule&#x27; must be in a classifier.</span></span><br><span class="line"><span class="comment"> * This may only be called by the exclusive writer. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cls_rule_make_invisible_in_version</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cls_rule *rule,</span></span><br><span class="line"><span class="params">                                   <span class="type">ovs_version_t</span> remove_version)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This undoes the change made by cls_rule_make_invisible_in_version().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;rule&#x27; must be in a classifier.</span></span><br><span class="line"><span class="comment"> * This may only be called by the exclusive writer. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cls_rule_restore_visibility</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cls_rule *rule)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span></span><br><span class="line"><span class="title function_">cls_rule_visible_in_version</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cls_rule *rule, <span class="type">ovs_version_t</span> version)</span>;</span><br></pre></td></tr></table></figure>



<p>åœ¨è§„åˆ™æ’å…¥æ—¶ï¼Œ<code>add_version</code>å’Œ<code>remove_version</code>ç›¸ç­‰ï¼Œå½“æ’å…¥å®Œæˆåï¼Œ<code>remove_version</code>è®¾ç½®ä¸º<code>OVS_VERSION_NOT_REMOVED</code>ï¼ˆovs_version_tçš„æœ€å¤§å€¼ï¼‰ã€‚</p>
<p>åœ¨è§„åˆ™æŸ¥æ‰¾æ—¶ä¼šæŒ‡å®šå½“å‰çš„ç‰ˆæœ¬å·ï¼Œåªæœ‰<code>add_version &lt;= cur_version &lt; remove_version</code>çš„ç‰ˆæœ¬å·æ‰å¯¹è°ƒç”¨è€…å¯è§ã€‚</p>
<h3 id="conjunctionå®ç°"><a href="#conjunctionå®ç°" class="headerlink" title="conjunctionå®ç°"></a>conjunctionå®ç°</h3><p>ç•¥</p>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-04-06</span>
            
            
             
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2024/01/01/dpdk/">dpdk</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2024 China 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠçœ‹è¿‡å¤§æµ·çš„äººä¸ä¼šå¿˜è®°æµ·çš„å¹¿é˜”ğŸŒŠ</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>
<script src="/js/emojiHandler.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    wrapEmojis('.paper');
  });
</script>
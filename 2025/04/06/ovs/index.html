<!DOCTYPE html>
<html lang="zh-Hans">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="dpdk" />
    <meta name="hexo-theme-A4" content="v1.9.7" />
    <link rel="alternate icon" type="image/webp" href="/images/Neurothingy.jpg">
    <title>Wuffaa | Blog</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


   
        
<link rel="stylesheet" href="/css/custom.css">

    

<meta name="generator" content="Hexo 6.3.0"></head>
    
    

    
    



    

    
    




    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 50%; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/images/Neurothingy.jpg" 
        />
        <div class="header-content">
            <a class="logo" href="/">Wuffaa</a> 
            <span class="description">el psy congroo</span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    dpdk
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2025-04-06</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š3.4k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š13åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#OVS"><span class="post-toc-text">OVS</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#CLS-CLASSIFIER"><span class="post-toc-text">CLS(CLASSIFIER)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#CLS-API"><span class="post-toc-text">CLS API</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#CLS%E5%BA%94%E7%94%A8"><span class="post-toc-text">CLSåº”ç”¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#route"><span class="post-toc-text">route</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#tunnel"><span class="post-toc-text">tunnel</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#openflow-table"><span class="post-toc-text">openflow table</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#CLS%E5%8E%9F%E7%90%86"><span class="post-toc-text">CLSåŸç†</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8E%A9%E7%A0%81%E4%BC%98%E5%8C%96"><span class="post-toc-text">æ©ç ä¼˜åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%88%86%E6%AE%B5hash%E5%8C%B9%E9%85%8D"><span class="post-toc-text">åˆ†æ®µhashåŒ¹é…</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%89%8D%E7%BC%80%E5%9F%9F%E5%8C%B9%E9%85%8D"><span class="post-toc-text">å‰ç¼€åŸŸåŒ¹é…</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%EF%BC%88Binary-trie%EF%BC%89"><span class="post-toc-text">å‰ç½®çŸ¥è¯†ï¼ˆBinary trieï¼‰</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%89%8D%E7%BC%80%E5%9F%9F"><span class="post-toc-text">è‡ªå®šä¹‰å‰ç¼€åŸŸ</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#%E5%86%85%E7%BD%AEl4-port%E5%89%8D%E7%BC%80%E5%9F%9F"><span class="post-toc-text">å†…ç½®l4 portå‰ç¼€åŸŸ</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%A7%84%E5%88%99%E7%89%88%E6%9C%AC%E5%8F%B7%E6%8E%A7%E5%88%B6"><span class="post-toc-text">è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#conjunction%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">conjunctionå®ç°</span></a></li></ol></li></ol></li></ol></li></ol>
            
        
        <div class=".article-gallery"><h1 id="OVS"><a href="#OVS" class="headerlink" title="OVS"></a>OVS</h1><h2 id="CLS-CLASSIFIER"><a href="#CLS-CLASSIFIER" class="headerlink" title="CLS(CLASSIFIER)"></a>CLS(CLASSIFIER)</h2><p>slowpathçš„æŠ¥æ–‡åˆ†ç±»å™¨ï¼Œæ ¹æ®ä¸‹å‘çš„è§„åˆ™ï¼Œå¯¹è¾“å…¥flowè¿›è¡ŒåŒ¹é…ï¼Œè¿”å›å‘½ä¸­çš„è§„åˆ™å¹¶è®¾ç½®è¯¥æ¬¡åŒ¹é…æ‰€æ„Ÿå…´è¶£çš„æ©ç ï¼ˆå¦‚æœæœ‰éœ€è¦çš„è¯ï¼‰ã€‚è¿™ä¸ªæ©ç ä¸ºfastpathæ‰€ç”¨ï¼Œfastpathä¼šæ ¹æ®æ©ç ä¸‹å‘å¹¶ç”Ÿæˆfastpathè§„åˆ™ï¼Œä½¿åé¢ç±»ä¼¼çš„æµé‡ï¼ˆæ©ç åå‘½ä¸­fastpathè§„åˆ™ï¼‰è¿›è¡Œå¿«è½¬ã€‚</p>
<h3 id="CLS-API"><a href="#CLS-API" class="headerlink" title="CLS API"></a>CLS API</h3><p>clsåˆå§‹åŒ–å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">classifier_init</span><span class="params">(<span class="keyword">struct</span> classifier *, <span class="type">const</span> <span class="type">uint8_t</span> *flow_segments)</span>;</span><br></pre></td></tr></table></figure>

<p>flow_segmentsä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºåˆ†æ®µç‚¹åœ¨flowä¸­çš„åç§»ï¼ˆ8å­—èŠ‚ä¸ºä¸€ä¸ªå•ä½ï¼‰ï¼Œæ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ çš„å€¼ä¸€å®šæ˜¯æ•´ä¸ªflowçš„å¤§å°ï¼ˆ8å­—èŠ‚ä¸ºä¸€ä¸ªå•ä½ï¼‰ã€‚</p>
<p>flow_segmentsä¼šå½±å“clsæ„å»ºçš„è¡Œä¸ºï¼Œåœ¨æ„å»ºæ—¶é€šè¿‡å¯¹flowè¿›è¡Œåˆ†æ®µï¼ŒåŠ é€Ÿäº†åŒ¹é…è¿‡ç¨‹ï¼Œä½¿å¾—å¯¹äºæ— æ³•å‘½ä¸­è§„åˆ™çš„flowèƒ½å¤Ÿæ›´å¿«é€Ÿçš„ç¡®å®šã€‚</p>
<p>clsè§„åˆ™åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cls_rule_init</span><span class="params">(<span class="keyword">struct</span> cls_rule *rule, <span class="type">const</span> <span class="keyword">struct</span> match *match, <span class="type">int</span> priority)</span>ï¼›</span><br></pre></td></tr></table></figure>



<p>clsè§„åˆ™æ’å…¥å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cls_conjunction</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> id;	<span class="comment">//conjunction_id</span></span><br><span class="line">    <span class="type">uint8_t</span> clause;	<span class="comment">//è¡¨æ˜è¯¥è§„åˆ™ä¸ºconjunction_idçš„ç¬¬å‡ ä¸ªç»´åº¦</span></span><br><span class="line">    <span class="type">uint8_t</span> n_clauses;<span class="comment">//è¡¨æ˜è¯¥conjunction_idæ€»å…±æœ‰å‡ ä¸ªç»´åº¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Inserts &#x27;rule&#x27; into &#x27;cls&#x27;.  Until &#x27;rule&#x27; is removed from &#x27;cls&#x27;, the caller</span></span><br><span class="line"><span class="comment"> * must not modify or free it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;cls&#x27; must not contain an identical rule (including wildcards, values of</span></span><br><span class="line"><span class="comment"> * fixed fields, and priority).  Use classifier_find_rule_exactly() to find</span></span><br><span class="line"><span class="comment"> * such a rule. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">classifier_insert</span><span class="params">(<span class="keyword">struct</span> classifier *, <span class="type">const</span> <span class="keyword">struct</span> cls_rule *,</span></span><br><span class="line"><span class="params">                       <span class="type">ovs_version_t</span>, <span class="type">const</span> <span class="keyword">struct</span> cls_conjunction *,</span></span><br><span class="line"><span class="params">                       <span class="type">size_t</span> n_conjunctions)</span>;</span><br></pre></td></tr></table></figure>

<p>conjunctionæ˜¯å¯é€‰åŠŸèƒ½ï¼Œç”¨äºovsçš„conjunctionåŠŸèƒ½å®ç°</p>
<p>clsè§„åˆ™åŒ¹é…å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Finds and returns the highest-priority rule in &#x27;cls&#x27; that matches &#x27;flow&#x27; and</span></span><br><span class="line"><span class="comment"> * that is visible in &#x27;version&#x27;.  Returns a null pointer if no rules in &#x27;cls&#x27;</span></span><br><span class="line"><span class="comment"> * match &#x27;flow&#x27;.  If multiple rules of equal priority match &#x27;flow&#x27;, returns one</span></span><br><span class="line"><span class="comment"> * arbitrarily.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If a rule is found and &#x27;wc&#x27; is non-null, bitwise-OR&#x27;s &#x27;wc&#x27; with the</span></span><br><span class="line"><span class="comment"> * set of bits that were significant in the lookup.  At some point</span></span><br><span class="line"><span class="comment"> * earlier, &#x27;wc&#x27; should have been initialized (e.g., by</span></span><br><span class="line"><span class="comment"> * flow_wildcards_init_catchall()).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;flow&#x27; is non-const to allow for temporary modifications during the lookup.</span></span><br><span class="line"><span class="comment"> * Any changes are restored before returning.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;conj_flows&#x27; is an optional parameter.  If it is non-null, the matching</span></span><br><span class="line"><span class="comment"> * conjunctive flows are inserted. */</span></span><br><span class="line"><span class="type">const</span> <span class="keyword">struct</span> cls_rule *</span><br><span class="line"><span class="title function_">classifier_lookup</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> classifier *cls, <span class="type">ovs_version_t</span> version,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> flow *flow, <span class="keyword">struct</span> flow_wildcards *wc,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> hmapx *conj_flows)</span>;</span><br></pre></td></tr></table></figure>



<h3 id="CLSåº”ç”¨"><a href="#CLSåº”ç”¨" class="headerlink" title="CLSåº”ç”¨"></a>CLSåº”ç”¨</h3><h4 id="route"><a href="#route" class="headerlink" title="route"></a>route</h4><h4 id="tunnel"><a href="#tunnel" class="headerlink" title="tunnel"></a>tunnel</h4><h4 id="openflow-table"><a href="#openflow-table" class="headerlink" title="openflow table"></a>openflow table</h4><h3 id="CLSåŸç†"><a href="#CLSåŸç†" class="headerlink" title="CLSåŸç†"></a>CLSåŸç†</h3><p>clsä¸»è¦æ˜¯åˆ©ç”¨hashè¡¨æ¥è¿›è¡Œè§„åˆ™çš„æ’å…¥å’ŒæŸ¥æ‰¾ã€‚</p>
<p><strong>clsè§„åˆ™åˆ†ä¸ºä¸‰éƒ¨åˆ†ç»„æˆ</strong>ï¼š</p>
<ul>
<li>cls_flowï¼šè®°å½•è§„åˆ™åŒ¹é…çš„å†…å®¹</li>
<li>cls_maskï¼šè®°å½•è§„åˆ™æ„Ÿå…´è¶£çš„åŒ¹é…é¡¹</li>
<li>cls_priorityï¼šè®°å½•è§„åˆ™ä¼˜å…ˆçº§</li>
</ul>
<p>å½“ä¸€ä¸ªflowé€å…¥clsä¸­è¿›è¡Œè§„åˆ™åŒ¹é…æ—¶ï¼Œé¦–å…ˆéœ€è¦å°†flowä¸clsè§„åˆ™ä¸­çš„<code>cls_mask</code>ç›¸ä¸ï¼Œå¾—åˆ°çš„åŒ¹é…ä¸²å†ä¸<code>cls_flow &amp; cls_mask</code>è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™å‘½ä¸­è¯¥è§„åˆ™ï¼Œè‹¥ä¸æƒ³ç­‰ï¼Œåˆ™æœªå‘½ä¸­è¯¥è§„åˆ™ã€‚</p>
<p>ç”±äºè§„åˆ™åŒ¹é…æ—¶ï¼Œflowå¿…é¡»ä¸<code>cls_mask</code>ç›¸ä¸åæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥åŒ¹é…ï¼Œæ‰€ä»¥clså°†clsè§„åˆ™æŒ‰ç…§<code>cls_mask</code>åˆ†åˆ°ä¸åŒçš„ç»„ä¸­ã€‚è¿™æ ·ï¼Œæ¯ç»„ä¸­çš„<code>cls_mask</code>éƒ½ç›¸åŒï¼Œflowåªéœ€è¦ä¸<code>cls_mask</code>ç›¸ä¸ä¸€æ¬¡ï¼Œå°±å¯ä»¥ä¸è¯¥ç»„ä¸­æ‰€æœ‰çš„clsè§„åˆ™è¿›è¡Œæ¯”è¾ƒäº†ã€‚è¿™ä¸ªç»„åœ¨clsä¸­è¢«ç§°ä¸ºsubtableã€‚</p>
<p><strong>subtableæ„æˆ</strong>ï¼š</p>
<ul>
<li>max_priorityï¼šè¡¨ç¤ºè¯¥subtableä¸­ä¼˜å…ˆçº§æœ€é«˜çš„è§„åˆ™çš„ä¼˜å…ˆçº§</li>
<li>index_mapsï¼šæ•´ä¸ªæ•°ç»„å­˜å‚¨ç€è¯¥subtableçš„maskï¼ˆè‡³äºä¸ºä»€ä¹ˆä½¿ç”¨æ•°ç»„å­˜ï¼Œåé¢çš„åˆ†æ®µhashåŒ¹é…æœ‰è®²åˆ°ï¼‰</li>
<li>rulesï¼šhashè¡¨ï¼Œkeyä¸º<code>cls_flow &amp; cls_mask</code>çš„hashå€¼ï¼Œvalueä¸ºclsè§„åˆ™</li>
</ul>
<p>ä¸‹é¢æ˜¯clsä¸­subtableçš„å…·ä½“å®ç°ï¼Œå…¶å¤§éƒ¨åˆ†å­—æ®µä¸ºä¹‹åæ‰€ä»‹ç»çš„æ©ç ä¼˜åŒ–æ‰€ç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cls_subtable</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmap_node</span> <span class="title">cmap_node</span>;</span>    <span class="comment">/* Within classifier&#x27;s &#x27;subtables_map&#x27;. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These fields are only used by writers. */</span></span><br><span class="line">    <span class="type">int</span> max_priority;              <span class="comment">/* Max priority of any rule in subtable. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> max_count;        <span class="comment">/* Count of max_priority rules. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Accessed by iterators. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rculist</span> <span class="title">rules_list</span>;</span>              <span class="comment">/* Unordered. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Identical, but lower priority rules are not inserted to any of the</span></span><br><span class="line"><span class="comment">     * following data structures. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These fields are accessed by readers who care about wildcarding. */</span></span><br><span class="line">    <span class="comment">//subtableå°†mask_flowåˆ†ä¸ºå¤šä¸ªä¸ä¸º0çš„åˆ†æ®µæ©ç ï¼Œæ¯ä¸ªåˆ†æ®µæ©ç å¯¹åº”ä¸€ä¸ªindex_maps</span></span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾æ—¶æŒ‰ç…§åˆ†æ®µæ©ç è¿›è¡Œåˆ†æ®µhashæŸ¥æ‰¾ï¼Œè¯¥å­—æ®µå°±è¡¨æ˜äº†è¯¥subtableéœ€è¦è¿›è¡Œå‡ æ¬¡çš„åˆ†æ®µæŸ¥æ‰¾</span></span><br><span class="line">    <span class="comment">//(è¿™é‡Œçš„æŸ¥æ‰¾æ¬¡æ•°ä¸ºåˆ†æ®µæ©ç ä¸ªæ•°-1)</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint8_t</span> n_indices;                   <span class="comment">/* How many indices to use. */</span></span><br><span class="line">    <span class="comment">//å­˜å‚¨åˆ†æ®µæ©ç </span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">flowmap</span> <span class="title">index_maps</span>[<span class="title">CLS_MAX_INDICES</span> + 1];</span> <span class="comment">/* Stage maps. */</span></span><br><span class="line">    <span class="comment">//è¯¥subtableçš„maskåœ¨trieæ ‘çš„å‰ç¼€æ©ç é•¿åº¦ï¼Œå¦‚æœä¸æ˜¯å‰ç¼€æ©ç ï¼Œåˆ™ä¸º0ï¼Œè¯¥trieä¸ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> trie_plen[CLS_MAX_TRIES];  <span class="comment">/* Trie prefix length in &#x27;mask&#x27;</span></span><br><span class="line"><span class="comment">                                             * (runtime configurable). */</span></span><br><span class="line">    <span class="comment">//l4å±‚çš„port_src + port_dst</span></span><br><span class="line">    <span class="comment">//å› ä¸ºå‰ç¼€æ©ç å¯èƒ½ä¸è¿ç»­ï¼Œå› æ­¤åœ¨æ’å…¥å’ŒåŒ¹é…æ—¶ä¸æ©ç ç›¸ä¸ï¼Œä¿è¯trieçš„æ­£ç¡®æ€§</span></span><br><span class="line">    <span class="comment">//å‰ç¼€é•¿åº¦ä¸ºMSBåˆ°LSB setä¹‹é—´é•¿åº¦ï¼ˆä¾‹ï¼š0b001000çš„å‰ç¼€é•¿åº¦ä¸º3ï¼‰</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> ports_mask_len;</span><br><span class="line">    <span class="comment">//ç”¨äºå­˜å‚¨åˆ†æ®µhashï¼Œæ¯ä¸ªåˆ†æ®µæ‰€è®¡ç®—å‡ºæ¥çš„hashå€¼åŒ…å«å‰é¢åˆ†æ®µçš„éƒ¨åˆ†çš„hashå€¼</span></span><br><span class="line">    <span class="comment">//å› æ­¤æœ€åä¸€ä¸ªåˆ†æ®µçš„hashå€¼åœ¨è¿™é‡Œå¹¶æ²¡æœ‰å­˜å‚¨ï¼Œå› ä¸ºæœ€åä¸€ä¸ªåˆ†æ®µçš„hashå€¼å°±æ˜¯æ•´ä¸ªminiflowçš„hashå€¼</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ccmap</span> <span class="title">indices</span>[<span class="title">CLS_MAX_INDICES</span>];</span>  <span class="comment">/* Staged lookup indices. */</span></span><br><span class="line">    <span class="comment">//portçš„æ©ç å¯èƒ½éå‰ç¼€ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ’å…¥å’ŒåŒ¹é…çš„æ•°æ®ä¸æ©ç ç›¸ä¸ï¼Œä¿è¯éå‰ç¼€æ©ç ä¸ä¼šå½±å“åˆ°trieçš„ä½¿ç”¨</span></span><br><span class="line">    rcu_trie_ptr ports_trie;                <span class="comment">/* NULL if none. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* These fields are accessed by all readers. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cmap</span> <span class="title">rules</span>;</span>                      <span class="comment">/* Contains &#x27;cls_match&#x27;es. */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">minimask</span> <span class="title">mask</span>;</span>             <span class="comment">/* Wildcards for fields. */</span></span><br><span class="line">    <span class="comment">/* &#x27;mask&#x27; must be the last field. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>clsè§„åˆ™æ’å…¥æµç¨‹</strong>ï¼š</p>
<ul>
<li>æ ¹æ®cls_maskæŸ¥æ‰¾å¯¹åº”çš„subtableï¼Œè‹¥æœªæ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„subtable</li>
<li>è‹¥æ‰¾åˆ°subtableï¼Œåˆ™è®¡ç®—è¯¥clsçš„hashå€¼ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°subtableä¸­ã€‚å¦‚æœè¯¥clsè§„åˆ™æ˜¯è¯¥subtableä¸­ä¼˜å…ˆçº§æœ€é«˜çš„è§„åˆ™ï¼Œåˆ™æ›´æ–°subtableçš„<code>max_priority</code></li>
</ul>
<p><strong>clsåŒ¹é…æµç¨‹</strong>ï¼š</p>
<ul>
<li>è®¾ç½®local_priorityä¸ºæœ€å°</li>
<li>æŒ‰ç…§ä¼˜å…ˆçº§ä»é«˜åˆ°ä½éå†subtableï¼Œå…¶ä¸­subtableçš„æœ€å°ä¼˜å…ˆçº§è¦å¤§äºlocal_priority</li>
<li>å°†å¾…åŒ¹é…çš„flowè·Ÿsubtableçš„maskç›¸ä¸ï¼Œè€Œåè®¡ç®—hashå€¼ï¼Œåœ¨<code>rules</code>ä¸­è¿›è¡ŒhashæŸ¥æ‰¾</li>
<li>è‹¥æ‰¾åˆ°è§„åˆ™ï¼Œä¸”ä¼˜å…ˆçº§æ¯”local_priorityå¤§ï¼Œåˆ™è®°å½•æ‰€å‘½ä¸­çš„clsè§„åˆ™ï¼Œæ›´æ–°local_priorityä¸ºæ‰€å‘½ä¸­çš„clsè§„åˆ™çš„ä¼˜å…ˆçº§</li>
<li>è·³åˆ°ç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ²¡æœ‰å¯è®¿é—®çš„subtableä¸ºæ­¢</li>
<li>æ­¤æ—¶æ‰€è®°å½•çš„clsè§„åˆ™ä¸ºæœ€ç»ˆæ‰€å‘½ä¸­çš„clsè§„åˆ™</li>
</ul>
<h4 id="æ©ç ä¼˜åŒ–"><a href="#æ©ç ä¼˜åŒ–" class="headerlink" title="æ©ç ä¼˜åŒ–"></a>æ©ç ä¼˜åŒ–</h4><p>ä¸»è¦ç”¨äºè§„åˆ™åŒ¹é…å¤±è´¥æ—¶wcæ©ç çš„è®¾ç½®ï¼ˆåŸºäºsubtableçš„ï¼Œå› ä¸ºè¯¥flowå¯èƒ½åœ¨æŸä¸ªä½ä¼˜å…ˆçº§çš„subtableä¸­å‘½ä¸­ï¼Œè€Œåœ¨æ¯”ä»–é«˜ä¼˜å…ˆçº§çš„subtableä¸­æœªå‘½ä¸­ï¼‰ã€‚</p>
<h5 id="åˆ†æ®µhashåŒ¹é…"><a href="#åˆ†æ®µhashåŒ¹é…" class="headerlink" title="åˆ†æ®µhashåŒ¹é…"></a>åˆ†æ®µhashåŒ¹é…</h5><p>æ ¹æ®flowç»“æ„ä½“çš„æˆå‘˜åˆ†å¸ƒï¼Œå°†flowåˆ†ä¸º4æ®µï¼š</p>
<ul>
<li>Metadataæ•°æ®æ®µ</li>
<li>L2æ•°æ®æ®µ</li>
<li>L3æ•°æ®æ®µ</li>
<li>L4æ•°æ®æ®µ</li>
</ul>
<p>åœ¨subtableåˆ›å»ºæ—¶ï¼Œå°†è¯¥subtableçš„æ©ç æŒ‰ç…§ä¸Šé¢çš„æè¿°åˆ†ä¸ºnæ®µï¼ˆè·³è¿‡æ©ç ä¸º0çš„æ•°æ®æ®µï¼Œæœ€å¤š4æ®µï¼‰ï¼Œå­˜åˆ°<code>index_maps</code>ä¸­</p>
<p><strong>è§„åˆ™æ’å…¥æ—¶</strong>ï¼š</p>
<ul>
<li>æ ¹æ®è§„åˆ™çš„maskæ‰¾åˆ°å¯¹åº”çš„subtable</li>
<li>ä¾æ¬¡è®¡ç®—å‰næ®µçš„hashï¼Œå¹¶æ’å…¥åˆ°<code>indices</code>ä¸­ï¼ˆè¿™é‡Œä¸åŒ…æ‹¬æœ€åä¸€æ®µï¼Œå› ä¸ºåŒ…æ‹¬äº†æœ€åä¸€æ®µå°±æ˜¯æ•´ä¸ªflowçš„hashï¼Œè€Œè¿™ä¸ªhashå€¼å·²ç»ä½œä¸ºkeyè¢«æ’å…¥åˆ°subtableçš„<code>rules</code>ä¸­ï¼‰</li>
</ul>
<p><strong>è§„åˆ™æŸ¥æ‰¾æ—¶</strong>ï¼š</p>
<ul>
<li>æ ¹æ®flowçš„maskæ‰¾åˆ°å¯¹åº”çš„subtable</li>
<li>é€šè¿‡å‰ç¼€åŸŸæ£€æŸ¥ï¼ˆä¼˜åŒ–2ï¼‰</li>
<li>æ ¹æ®è¯¥subtableçš„åˆ†æ®µæ©ç ï¼Œè®¡ç®—è¯¥flowå‰næ®µæ©ç åçš„hashï¼Œå¹¶åœ¨<code>indices</code>ä¸­æŸ¥æ‰¾<ul>
<li>è‹¥æŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™å°†wcè®¾ç½®ä¸ºè¯¥subtableå‰næ®µçš„æ©ç </li>
<li>è‹¥æŸ¥æ‰¾æˆåŠŸï¼Œåˆ™å°†wcè®¾ç½®ä¸ºè¯¥subtableçš„æ©ç ï¼Œå¹¶è¿”å›å‘½ä¸­çš„clsè§„åˆ™</li>
</ul>
</li>
</ul>
<h5 id="å‰ç¼€åŸŸåŒ¹é…"><a href="#å‰ç¼€åŸŸåŒ¹é…" class="headerlink" title="å‰ç¼€åŸŸåŒ¹é…"></a>å‰ç¼€åŸŸåŒ¹é…</h5><h6 id="å‰ç½®çŸ¥è¯†ï¼ˆBinary-trieï¼‰"><a href="#å‰ç½®çŸ¥è¯†ï¼ˆBinary-trieï¼‰" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼ˆBinary trieï¼‰"></a>å‰ç½®çŸ¥è¯†ï¼ˆBinary trieï¼‰</h6><p>å‰ç¼€äºŒå‰æ ‘ï¼Œä¸€ç§ç”¨äºå¿«é€Ÿæ£€ç´¢çš„äºŒå‰æ ‘ç»“æ„ï¼Œå…¶åŸºæœ¬æ€§è´¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>èŠ‚ç‚¹å­˜å‚¨æœ€å¤š32ä½çš„å‰ç¼€ä¿¡æ¯å’Œè¯¥èŠ‚ç‚¹å¯å‘½ä¸­çš„è§„åˆ™æ•°</li>
<li>èŠ‚ç‚¹æŒ‡å‘å·¦å­©å­çš„è¾¹ä»£è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯çš„æœ€é«˜ä½ä¸º0ï¼ŒæŒ‡å‘å³å­©å­çš„è¾¹ä»£è¡¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯çš„æœ€é«˜ä½ä¸º1</li>
<li>æ ¹èŠ‚ç‚¹ä¸­çš„å‰ç¼€ä¿¡æ¯ä¸ºå‰ç¼€ä¸²çš„ç¬¬ä¸€ä½ä¸ºMSBï¼Œå¶èŠ‚ç‚¹ä¸­çš„å‰ç¼€ä¿¡æ¯çš„æœ€åä¸€ä½ä¸ºLSB</li>
<li>æ ¹èŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯å¯èƒ½ä¸ºç©º</li>
<li>ä»æ ¹èŠ‚ç‚¹åˆ°æŸä¸€ç»“ç‚¹ï¼Œè·¯å¾„ä¸Šç»è¿‡èŠ‚ç‚¹çš„å‰ç¼€ä¿¡æ¯è¿æ¥èµ·æ¥ï¼Œä¸ºè¯¥èŠ‚ç‚¹å¯¹åº”çš„å®Œæ•´çš„å‰ç¼€ä¸²</li>
</ul>
<p>ä¾‹ï¼šæ·»åŠ ä¸‰æ¡è§„åˆ™åˆ°trieä¸­</p>
<table>
<thead>
<tr>
<th>rule1</th>
<th>rule2</th>
<th>rule3</th>
</tr>
</thead>
<tbody><tr>
<td>0b1011&#x2F;0b1111</td>
<td>0b1011&#x2F;0b1000</td>
<td>0b0100&#x2F;0b1100</td>
</tr>
</tbody></table>
<p>æ„å»ºçš„binary trieå¦‚ä¸‹ï¼š</p>
<p><a href="/images/binary_trie.svg" title="binary_trie" class="gallery-item" style="box-shadow: none;"> <img src="/images/binary_trie.svg" alt="binary_trie"></a></p>
<h6 id="è‡ªå®šä¹‰å‰ç¼€åŸŸ"><a href="#è‡ªå®šä¹‰å‰ç¼€åŸŸ" class="headerlink" title="è‡ªå®šä¹‰å‰ç¼€åŸŸ"></a>è‡ªå®šä¹‰å‰ç¼€åŸŸ</h6><p>é€šè¿‡APIæ¥è®¾ç½®clsçš„trieï¼Œåœ¨è§„åˆ™åŒ¹é…æ—¶ç”¨äºç”ŸæˆåŒ¹é…å¤±è´¥çš„wcã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//clsè‡ªå®šä¹‰å‰ç¼€åŸŸè®¾ç½®ï¼Œè¿™äº›å‰ç¼€åŸŸå¯ä»¥ä½¿å¾—åŒ¹é…åæ‰€ç”Ÿæˆçš„æ©ç æ›´å°ï¼Œä¿è¯äº†æ‰€ä¸‹å‘çš„fastpathè§„åˆ™å°½å¯èƒ½çš„èšåˆã€‚</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">classifier_set_prefix_fields</span><span class="params">(<span class="keyword">struct</span> classifier *,</span></span><br><span class="line"><span class="params">                                  <span class="type">const</span> <span class="keyword">enum</span> mf_field_id *trie_fields,</span></span><br><span class="line"><span class="params">                                  <span class="type">unsigned</span> <span class="type">int</span> n_trie_fields)</span>;</span><br></pre></td></tr></table></figure>

<p>trieæ˜¯åŸºäºclsçš„ï¼Œæ¯ä¸ªtrieå¯¹åº”ä¸€ä¸ªmeta-flow fieldï¼Œç›®å‰æœ€å¤šæ”¯æŒ4ä¸ªtrieï¼Œä¸€èˆ¬ä¸º<code>ipv4_srcã€ipv4_dstã€ipv6_srcã€ipv6_dst</code>ã€‚</p>
<blockquote>
<p>trieæ‰€å¯¹åº”çš„fieldåœ¨è§„åˆ™ä¸­ä¸€å®šè¦ä½¿ç”¨å‰ç¼€æ©ç ï¼Œå¦åˆ™è¯¥è§„åˆ™æ‰€å¤„çš„subtableä¸­çš„trieçš„å‰ç¼€é•¿åº¦ä¸º0ï¼Œæ— æ³•ç”Ÿæˆèšåˆçš„wc</p>
</blockquote>
<p><strong>è§„åˆ™æ’å…¥æ—¶å¯¹trieçš„æ“ä½œ</strong>ï¼š</p>
<ul>
<li>æ ¹æ®è§„åˆ™çš„maskï¼ŒæŸ¥æ‰¾å¯¹åº”çš„subtableã€‚subtableä¸­å­˜å‚¨ç€è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼ˆå› ä¸ºsubtableä¸­æ‰€æœ‰çš„è§„åˆ™çš„æ©ç éƒ½ç›¸åŒï¼Œæ‰€ä»¥trieçš„å‰ç¼€é•¿åº¦æ˜¯ç”±subtableå­˜å‚¨ï¼‰</li>
<li>æ ¹æ®subtableä¸­å¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼Œè·å–è¯¥è§„åˆ™å¯¹åº”å‰ç¼€åŸŸçš„å‰ç¼€ä¸²ï¼Œå¹¶æ’å…¥trieä¸­</li>
</ul>
<p><strong>è§„åˆ™åŒ¹é…æ—¶å¯¹trieçš„æ“ä½œ</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Prefix tree context.  Valid when &#x27;lookup_done&#x27; is true.  Can skip all</span></span><br><span class="line"><span class="comment"> * subtables which have a prefix match on the trie field, but whose prefix</span></span><br><span class="line"><span class="comment"> * length is not indicated in &#x27;match_plens&#x27;.  For example, a subtable that</span></span><br><span class="line"><span class="comment"> * has a 8-bit trie field prefix match can be skipped if</span></span><br><span class="line"><span class="comment"> * !be_get_bit_at(&amp;match_plens, 8 - 1).  If skipped, &#x27;maskbits&#x27; prefix bits</span></span><br><span class="line"><span class="comment"> * must be unwildcarded to make datapath flow only match packets it should. */</span></span><br><span class="line"><span class="comment">//è§„åˆ™åŒ¹é…æ—¶æ‰€ä½¿ç”¨çš„trieçš„ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trie_ctx</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cls_trie</span> *<span class="title">trie</span>;</span></span><br><span class="line">    <span class="type">bool</span> lookup_done;        <span class="comment">/* Status of the lookup. */</span></span><br><span class="line">    <span class="comment">//å¯¹flowçš„fieldä»…éœ€è¦åŒ¹é…maskbitsé•¿åº¦çš„å‰ç¼€å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„åŒ¹é…ç»“æœ</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> maskbits;   <span class="comment">/* Prefix length needed to avoid false matches. */</span></span><br><span class="line">    <span class="comment">//è®°å½•è¯¥flowæ‰€å‘½ä¸­çš„å‰ç¼€é•¿åº¦ï¼Œç¬¬nä½ä¸º1è¡¨ç¤ºå‘½ä¸­äº†å‰ç¼€é•¿åº¦ä¸ºn+1çš„è§„åˆ™ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">trie_prefix</span> <span class="title">match_plens</span>;</span>  <span class="comment">/* Bitmask of prefix lengths with possible</span></span><br><span class="line"><span class="comment">                                     * matches. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>æ ¹æ®trieæ‰€å¯¹åº”çš„å‰ç¼€åŸŸï¼Œä»å¾…åŒ¹é…çš„flowä¸­æå–è¯¥å­—æ®µæ‰€å¯¹åº”çš„åŒ¹é…ä¸²</p>
</li>
<li><p>å°†è¯¥åŒ¹é…ä¸²é€å…¥trieä¸­è¿›è¡ŒåŒ¹é…ï¼Œå°†åŒ¹é…ç»“æœå­˜åœ¨<code>trie_ctx</code>ä¸­</p>
</li>
<li><p>åˆ¤æ–­æ˜¯å¦å¯èƒ½å‘½ä¸­äº†è¯¥subtableä¸­çš„è§„åˆ™ï¼ˆè®¾è¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ä¸ºnï¼‰ï¼šä¹Ÿå°±æ˜¯åˆ¤æ–­<code>match_plens</code>çš„ç¬¬n-1ä½æ˜¯å¦ä¸º1ã€‚è‹¥ä¸º1ï¼Œåˆ™è¯´æ˜å¯èƒ½å‘½ä¸­äº†è¯¥subtableçš„è§„åˆ™ï¼Œè‹¥ä¸º0ï¼Œåˆ™è¯´æ˜ä¸€å®šæ²¡æœ‰å‘½ä¸­è¯¥subtableçš„è§„åˆ™</p>
<blockquote>
<p> è¿™é‡Œè¯´å¯èƒ½å‘½ä¸­ï¼Œæ˜¯å› ä¸ºä¸åŒsubtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å¯èƒ½ç›¸åŒï¼Œè‹¥ä¸º1ï¼Œä¹Ÿå¯èƒ½å‘½ä¸­äº†å…¶ä»–subtableä¸­çš„è§„åˆ™</p>
</blockquote>
<ul>
<li><p>è‹¥å¯èƒ½å‘½ä¸­è¯¥subtableä¸­çš„è§„åˆ™ï¼šä¸åšä»»ä½•æ“ä½œã€‚å› ä¸ºtrieåªå¯¹æœªå‘½ä¸­è§„åˆ™çš„wcåšä¼˜åŒ–ã€‚</p>
</li>
<li><p>è‹¥æœªå‘½ä¸­è¯¥subtableä¸­çš„è§„åˆ™ï¼š</p>
<ul>
<li><p>å¦‚æœè¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å¤§äºç­‰äºmaskbitsï¼Œåˆ™è®¾ç½®wcä¸­å¯¹åº”trieçš„å‰ç¼€åŸŸçš„å‰ç¼€æ©ç ï¼Œæ©ç é•¿åº¦ä¸º<code>maskbits</code>ã€‚å¹¶è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚</p>
<blockquote>
<p>å› ä¸ºmaskbitsé•¿åº¦çš„æ©ç å·²ç»èƒ½ç¡®å®šäº†å¯¹äºè¯¥fieldï¼Œflowå’Œwcæ©ç åä¸€å®šæ²¡æœ‰å‘½ä¸­è¯¥subtableçš„è§„åˆ™ã€‚</p>
<p>ä½†ä¸ºä»€ä¹ˆè¦å¯¹wcè®¾ç½®maskbitsçš„å‰ç¼€é•¿åº¦ï¼Œè€Œä¸æ˜¯subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å‘¢ï¼Ÿ</p>
</blockquote>
</li>
<li><p>å¦‚æœè¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å°äº<code>maskbits</code>ï¼Œåˆ™åˆ¤æ–­wcä¸­æ˜¯å¦è®¾ç½®äº†æ©ç é•¿åº¦ä¸º<code>maskbits</code>çš„æ©ç ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚å¦‚æœæ²¡è®¾ç½®ï¼Œåˆ™ç»§ç»­è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚</p>
<blockquote>
<p>å½“subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦å°äºmaskbitsæ—¶ï¼Œä¸ºä»€ä¹ˆä¸è®¾ç½®wcä¸ºsubtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼Œå¹¶è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…å‘¢ï¼Ÿè¿™æ ·åšä¸æ˜¯èƒ½è¾¾åˆ°æ©ç çš„æœ€å°åŒ–å—ï¼Ÿä¸ç†è§£</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>ä¸ªäººè®¤ä¸ºï¼Œå½“trieè‹¥æœªå‘½ä¸­è¯¥subtableä¸­çš„è§„åˆ™æ—¶ï¼Œç›´æ¥å¯¹wcè®¾ç½®è¯¥subtableå¯¹è¯¥trieçš„å‰ç¼€é•¿åº¦ï¼Œå¹¶è·³è¿‡è¯¥subtableçš„è§„åˆ™åŒ¹é…ã€‚maskbitsä¸å†éœ€è¦ã€‚</p>
</blockquote>
<h6 id="å†…ç½®l4-portå‰ç¼€åŸŸ"><a href="#å†…ç½®l4-portå‰ç¼€åŸŸ" class="headerlink" title="å†…ç½®l4 portå‰ç¼€åŸŸ"></a>å†…ç½®l4 portå‰ç¼€åŸŸ</h6><p>ä¸ä¼˜åŒ–2ç±»ä¼¼ï¼Œä½¿ç”¨trieæ„å»ºï¼Œå› ä¸ºportçš„å‰ç¼€æ©ç å¯èƒ½ä¸è¿ç»­ï¼Œå› æ­¤åœ¨æ’å…¥å’ŒåŒ¹é…æ—¶ä¸æ©ç ç›¸ä¸ï¼Œä¿è¯trieçš„æ­£ç¡®æ€§ã€‚l4 portçš„å‰ç¼€é•¿åº¦ä¸º<strong>MSB</strong>åˆ°<strong>LSB 1</strong>ä¹‹é—´é•¿åº¦ï¼ˆ0b001000çš„å‰ç¼€é•¿åº¦ä¸º3ï¼‰</p>
<p>è¯¥port_trieæ˜¯åŸºäºsubtableçš„ã€‚åœ¨subtableä¸­ï¼Œå¯¹è¯¥flowè¿›è¡Œå…¨é‡åŒ¹é…åï¼Œä»æœªå‘½ä¸­è§„åˆ™ï¼Œåˆ™å¯¹è¯¥port_trieè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ ¹æ®æŸ¥æ‰¾ç»“æœç¡®å®š<code>port_mask</code>ï¼Œå¹¶å°†å…¶è®¾ç½®åˆ°wcçš„l4 portå‰ç¼€åŸŸä¸­ã€‚</p>
<p><strong>è§„åˆ™æ’å…¥æ—¶å¯¹port_trieçš„æ“ä½œ</strong>ï¼š</p>
<ul>
<li>æ ¹æ®è§„åˆ™çš„maskï¼ŒæŸ¥æ‰¾å¯¹åº”çš„subtableã€‚subtableä¸­å­˜å‚¨ç€è¯¥port_trieåŠport_trieçš„å‰ç¼€é•¿åº¦</li>
<li>æ ¹æ®subtableä¸­å¯¹è¯¥port_trieçš„å‰ç¼€é•¿åº¦ï¼Œè·å–è¯¥è§„åˆ™ä¸­l4 portçš„å‰ç¼€ä¸²ï¼ˆ<code>[port_src, port_dst] &amp; cls_mask</code>ï¼‰ï¼Œå¹¶æ’å…¥trieä¸­</li>
</ul>
<p><strong>è§„åˆ™åŒ¹é…æ—¶å¯¹port_trieçš„æ“ä½œ</strong>ï¼š</p>
<ul>
<li>å½“subtableå¯¹è¯¥flowè¿›è¡Œå…¨é‡åŒ¹é…ä¸”æœªå‘½ä¸­åï¼Œæå–flowçš„portä¿¡æ¯ï¼ˆ<code>[port_src, port_dst] &amp; subtable_mask</code>ï¼‰ï¼Œåœ¨port_trieä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¹¶è¿”å›åŒ¹é…é•¿åº¦ï¼ˆè¿™ä¸ªåŒ¹é…é•¿åº¦è·Ÿtrie_ctxä¸­çš„<code>maskbits</code>ä¸€ä¸ªå«ä¹‰ï¼‰</li>
<li>å°†è¿™ä¸ªé•¿åº¦ä½œä¸ºå‰ç¼€æ©ç é•¿åº¦ï¼Œå¹¶è®¾ç½®åˆ°wcçš„l4 portä¸­</li>
</ul>
<h4 id="è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶"><a href="#è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶" class="headerlink" title="è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶"></a>è§„åˆ™ç‰ˆæœ¬å·æ§åˆ¶</h4><p>ç‰ˆæœ¬å·å¯æ§åˆ¶clsä¸­çš„clsè§„åˆ™æ˜¯å¦å¯¹ç”¨æˆ·å¯è§ï¼Œåœ¨clsè§„åˆ™æ’å…¥å’Œclsè§„åˆ™åŒ¹é…æ—¶ï¼Œéƒ½ä¼šå¸¦æœ‰å½“å‰ç‰ˆæœ¬å·ä¿¡æ¯ã€‚ç‰ˆæœ¬å·çš„æ§åˆ¶æ˜¯ä»¥clsè§„åˆ™ä¸ºå•ä½çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡APIå¯¹ç‰¹å®šçš„è§„åˆ™çš„ç‰ˆæœ¬å·è¿›è¡Œæ§åˆ¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">versions</span> &#123;</span></span><br><span class="line">    <span class="type">ovs_version_t</span> add_version;              <span class="comment">/* Version object was added in. */</span></span><br><span class="line">    ATOMIC(<span class="type">ovs_version_t</span>) remove_version;   <span class="comment">/* Version object is removed in. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Makes &#x27;rule&#x27; invisible in &#x27;remove_version&#x27;.  Once that version is used in</span></span><br><span class="line"><span class="comment"> * lookups, the caller should remove &#x27;rule&#x27; via ovsrcu_postpone().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;rule&#x27; must be in a classifier.</span></span><br><span class="line"><span class="comment"> * This may only be called by the exclusive writer. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cls_rule_make_invisible_in_version</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cls_rule *rule,</span></span><br><span class="line"><span class="params">                                   <span class="type">ovs_version_t</span> remove_version)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This undoes the change made by cls_rule_make_invisible_in_version().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;rule&#x27; must be in a classifier.</span></span><br><span class="line"><span class="comment"> * This may only be called by the exclusive writer. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cls_rule_restore_visibility</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cls_rule *rule)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span></span><br><span class="line"><span class="title function_">cls_rule_visible_in_version</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cls_rule *rule, <span class="type">ovs_version_t</span> version)</span>;</span><br></pre></td></tr></table></figure>



<p>åœ¨è§„åˆ™æ’å…¥æ—¶ï¼Œ<code>add_version</code>å’Œ<code>remove_version</code>ç›¸ç­‰ï¼Œå½“æ’å…¥å®Œæˆåï¼Œ<code>remove_version</code>è®¾ç½®ä¸º<code>OVS_VERSION_NOT_REMOVED</code>ï¼ˆovs_version_tçš„æœ€å¤§å€¼ï¼‰ã€‚</p>
<p>åœ¨è§„åˆ™æŸ¥æ‰¾æ—¶ä¼šæŒ‡å®šå½“å‰çš„ç‰ˆæœ¬å·ï¼Œåªæœ‰<code>add_version &lt;= cur_version &lt; remove_version</code>çš„ç‰ˆæœ¬å·æ‰å¯¹è°ƒç”¨è€…å¯è§ã€‚</p>
<h4 id="conjunctionå®ç°"><a href="#conjunctionå®ç°" class="headerlink" title="conjunctionå®ç°"></a>conjunctionå®ç°</h4><p>ç•¥</p>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-04-06</span>
            
            
             
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2024/01/01/dpdk/">dpdk</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2024 China 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠçœ‹è¿‡å¤§æµ·çš„äººä¸ä¼šå¿˜è®°æµ·çš„å¹¿é˜”ğŸŒŠ</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>